services:
  # MongoDB Database
  mongodb:
    image: mongo:7.0
    container_name: iot-mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-admin123}
      MONGO_INITDB_DATABASE: ${MONGO_DB:-iot_smarttile}
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    networks:
      - iot-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  # Mosquitto MQTT Broker
  mosquitto:
    image: eclipse-mosquitto:2.0
    container_name: iot-mosquitto
    restart: unless-stopped
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./backend/config/mosquitto.conf:/mosquitto/config/mosquitto.conf
      - ./backend/config/pwfile:/mosquitto/config/pwfile
      - mosquitto_data:/mosquitto/data
      - mosquitto_log:/mosquitto/log
    networks:
      - iot-network
    healthcheck:
      test: ["CMD", "mosquitto_sub", "-t", "$$SYS/#", "-C", "1", "-i", "healthcheck", "-u", "user1", "-P", "user1", "-W", "3"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  # ASP.NET Core Backend API
  backend:
    build:
      context: ./backend/src/IoT.Backend
      dockerfile: Dockerfile
    container_name: iot-backend
    restart: unless-stopped
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ConnectionStrings__MongoDB: mongodb://${MONGO_ROOT_USER:-admin}:${MONGO_ROOT_PASSWORD:-admin123}@mongodb:27017
      MongoDB__Database: ${MONGO_DB:-iot_smarttile}
      Mqtt__Host: mosquitto
      Mqtt__Port: 1883
      Mqtt__Username: ${MQTT_USERNAME:-user1}
      Mqtt__Password: ${MQTT_PASSWORD:-user1}
      ApiSecurity__ApiKey: ${API_KEY:-hydro-thesis-2026}
      Cors__Origins__0: http://localhost:4200
      Cors__Origins__1: http://frontend:80
    ports:
      - "8000:8000"
    depends_on:
      mongodb:
        condition: service_healthy
      mosquitto:
        condition: service_healthy
    networks:
      - iot-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/live"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # Angular Frontend
  frontend:
    build:
      context: ./Frontend
      dockerfile: Dockerfile
    container_name: iot-frontend
    restart: unless-stopped
    environment:
      API_URL: ${API_URL:-http://backend:8000}
      WS_URL: ${WS_URL:-ws://backend:8000/ws}
    ports:
      - "4200:80"
    depends_on:
      - backend
    networks:
      - iot-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:80"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Machine Learning API Service
  ml-api:
    build:
      context: ./ml
      dockerfile: Dockerfile
    container_name: iot-ml-api
    restart: unless-stopped
    environment:
      MONGODB_HOST: mongodb
      MONGODB_PORT: 27017
      MONGODB_DATABASE: ${MONGO_DB:-iot_smarttile}
      MONGODB_USERNAME: ${MONGO_ROOT_USER:-admin}
      MONGODB_PASSWORD: ${MONGO_ROOT_PASSWORD:-admin123}
      MQTT_HOST: mosquitto
      MQTT_PORT: 1883
      MQTT_USERNAME: ${MQTT_USERNAME:-user1}
      MQTT_PASSWORD: ${MQTT_PASSWORD:-user1}
      ML_API_HOST: "0.0.0.0"
      ML_API_PORT: "8000"
    ports:
      - "8001:8000"  # ML API
    volumes:
      - ./ml/src:/app/src
      - ./ml/models:/app/models
      - ml_data:/app/data
    depends_on:
      mongodb:
        condition: service_healthy
      mosquitto:
        condition: service_healthy
    networks:
      - iot-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  # JupyterLab for ML development
  ml-jupyter:
    build:
      context: ./ml
      dockerfile: Dockerfile
    container_name: iot-ml-jupyter
    restart: unless-stopped
    command: ["jupyter", "lab", "--ip=0.0.0.0", "--port=8888", "--no-browser", "--allow-root", "--NotebookApp.token=''"]
    environment:
      MONGODB_HOST: mongodb
      MONGODB_PORT: 27017
      MONGODB_DATABASE: ${MONGO_DB:-iot_smarttile}
      MONGODB_USERNAME: ${MONGO_ROOT_USER:-admin}
      MONGODB_PASSWORD: ${MONGO_ROOT_PASSWORD:-admin123}
      MQTT_HOST: mosquitto
      MQTT_PORT: 1883
      MQTT_USERNAME: ${MQTT_USERNAME:-user1}
      MQTT_PASSWORD: ${MQTT_PASSWORD:-user1}
    ports:
      - "8888:8888"  # JupyterLab
    volumes:
      - ./ml/notebooks:/app/notebooks
      - ./ml/src:/app/src
      - ./ml/models:/app/models
      - ml_data:/app/data
    depends_on:
      mongodb:
        condition: service_healthy
      mosquitto:
        condition: service_healthy
    networks:
      - iot-network
    profiles:
      - dev  # Only start with: docker compose --profile dev up

networks:
  iot-network:
    driver: bridge

volumes:
  mongodb_data:
  mongodb_config:
  mosquitto_data:
  mosquitto_log:
  ml_data:
