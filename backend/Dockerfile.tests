FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build

WORKDIR /src

# Copy all project files first for better layer caching
COPY backend/src/IoT.Backend/IoT.Backend.csproj backend/src/IoT.Backend/
COPY backend/tests/IoT.Backend.IntegrationTests/IoT.Backend.IntegrationTests.csproj backend/tests/IoT.Backend.IntegrationTests/

# Restore dependencies
RUN dotnet restore backend/tests/IoT.Backend.IntegrationTests/IoT.Backend.IntegrationTests.csproj

# Copy all source code
COPY backend/ Backend/

# Build (with restore to ensure all deps are resolved)
RUN dotnet build backend/tests/IoT.Backend.IntegrationTests/IoT.Backend.IntegrationTests.csproj -c Release

# Testcontainers configuration for Docker-in-Docker (DinD) scenarios
# Disable Ryuk (Resource Reaper) as it causes issues in DinD
ENV TESTCONTAINERS_RYUK_DISABLED=true
# Use host.docker.internal to access containers from inside Docker
ENV TESTCONTAINERS_HOST_OVERRIDE=host.docker.internal
# Set Docker host to use the socket
ENV DOCKER_HOST=unix:///var/run/docker.sock

# Run tests (Testcontainers needs access to Docker socket)
ENTRYPOINT ["dotnet", "test", "backend/tests/IoT.Backend.IntegrationTests/IoT.Backend.IntegrationTests.csproj", "--no-build", "-c", "Release", "--logger", "console;verbosity=detailed"]
