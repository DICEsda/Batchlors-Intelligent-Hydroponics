# Simulation Environment â€” isolated from development
# Usage:
#   docker compose -f docker-compose.simulation.yml up -d
#   docker compose -f docker-compose.simulation.yml run simulator --scenario alert-cascade
#   docker compose -f docker-compose.simulation.yml run simulator python -m pytest tests/ -v
#   docker compose -f docker-compose.simulation.yml down -v

services:
  # MongoDB (simulation)
  mongodb-sim:
    image: mongo:7.0
    container_name: sim-mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin123
      MONGO_INITDB_DATABASE: iot_smarttile
    ports:
      - "27018:27017"
    volumes:
      - sim_mongodb_data:/data/db
    networks:
      - sim-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  # Mosquitto MQTT Broker (simulation)
  mosquitto-sim:
    image: eclipse-mosquitto:2.0
    container_name: sim-mosquitto
    restart: unless-stopped
    ports:
      - "1884:1883"
    volumes:
      - ./backend/config/mosquitto.conf:/mosquitto/config/mosquitto.conf
      - ./backend/config/pwfile:/mosquitto/config/pwfile
      - sim_mosquitto_data:/mosquitto/data
    networks:
      - sim-network
    healthcheck:
      test: ["CMD", "mosquitto_sub", "-t", "$$SYS/#", "-C", "1", "-i", "healthcheck", "-u", "user1", "-P", "user1", "-W", "3"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  # ASP.NET Core Backend (simulation)
  backend-sim:
    build:
      context: ./backend/src/IoT.Backend
      dockerfile: Dockerfile
    container_name: sim-backend
    restart: unless-stopped
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ConnectionStrings__MongoDB: mongodb://admin:admin123@mongodb-sim:27017
      MongoDB__Database: iot_smarttile
      Mqtt__Host: mosquitto-sim
      Mqtt__Port: 1883
      Mqtt__Username: user1
      Mqtt__Password: user1
      ApiSecurity__ApiKey: ${API_KEY:-hydro-thesis-2026}
      Cors__Origins__0: "*"
    ports:
      - "8010:8000"
    depends_on:
      mongodb-sim:
        condition: service_healthy
      mosquitto-sim:
        condition: service_healthy
    networks:
      - sim-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/live"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # Simulator
  simulator:
    build:
      context: ./tools/simulator
      dockerfile: Dockerfile
    container_name: sim-simulator
    environment:
      SIM_MQTT_HOST: mosquitto-sim
      SIM_MQTT_PORT: "1883"
      SIM_MQTT_USER: user1
      SIM_MQTT_PASS: user1
      SIM_API_URL: http://backend-sim:8000
    depends_on:
      backend-sim:
        condition: service_healthy
    networks:
      - sim-network
    # Default: run steady-state for 10 minutes
    command: >
      --scenario steady-state
      --mqtt-host mosquitto-sim
      --mqtt-port 1883
      --api-url http://backend-sim:8000
      --duration 600

networks:
  sim-network:
    driver: bridge

volumes:
  sim_mongodb_data:
  sim_mosquitto_data:
