<div class="farm-overview">
  <section class="dashboard-grid">
    <!-- Top Row — Compact Stat Cards -->
    <div class="top-row">
      <div class="stat-card">
        @if (loading()) {
          <hlm-skeleton class="stat-skeleton" />
        } @else {
          <div class="stat-icon-sm coordinators">
            <ng-icon hlmIcon name="lucideServer" size="sm" />
          </div>
          <div class="stat-body">
            <span class="stat-value-sm">{{ coordTwins().length || systemStats().coordinators.total }}</span>
            <span class="stat-label-sm">Reservoirs</span>
          </div>
          <span hlmBadge variant="outline" class="stat-badge">Live</span>
        }
      </div>

      <div class="stat-card">
        @if (loading()) {
          <hlm-skeleton class="stat-skeleton" />
        } @else {
          <div class="stat-icon-sm towers">
            <ng-icon hlmIcon name="lucideLayoutGrid" size="sm" />
          </div>
          <div class="stat-body">
            <span class="stat-value-sm">{{ towerTwins().length || systemStats().nodes.total }}</span>
            <span class="stat-label-sm">Towers</span>
          </div>
          <span hlmBadge variant="outline" class="stat-badge">Active</span>
        }
      </div>

      <div class="stat-card" [class.has-alerts]="systemStats().alerts.critical > 0">
        @if (loading()) {
          <hlm-skeleton class="stat-skeleton" />
        } @else {
          <div class="stat-icon-sm alerts" [class.critical]="systemStats().alerts.critical > 0">
            <ng-icon hlmIcon name="lucideAlertTriangle" size="sm" />
          </div>
          <div class="stat-body">
            <span class="stat-value-sm">{{ systemStats().alerts.total }}</span>
            <span class="stat-label-sm">Alerts</span>
          </div>
          @if (systemStats().alerts.critical > 0) {
            <span hlmBadge variant="destructive" class="stat-badge">{{ systemStats().alerts.critical }} Critical</span>
          } @else {
            <span hlmBadge variant="outline" class="stat-badge">OK</span>
          }
        }
      </div>
    </div>

    <!-- Bottom Row — Two Panel: Detail Card (left) + Topology Graph (right) -->
    <div class="bottom-row">
      <!-- LEFT: Detail Card -->
      <div class="dashboard-card detail-card">
        <div class="detail-card-inner">

          <!-- Coordinator Detail -->
          <ng-container *ngIf="selectedCoordTwin() as coord">
            <div class="detail-content">
              <div class="detail-header">
                <div class="detail-title-row">
                  <span class="chain-dot coord-dot lg"></span>
                  <div>
                    <h3 class="detail-title">{{ coord.name }}</h3>
                    <span class="detail-subtitle">{{ coord.coordId }} &middot; Reservoir</span>
                  </div>
                </div>
                <button class="detail-close" (click)="clearSelection()">
                  <ng-icon hlmIcon name="lucideX" size="sm" />
                </button>
              </div>

              <div class="detail-status-row">
                <span class="detail-badge" [class]="'sync-badge ' + getSyncStatusClass(coord.metadata.syncStatus)">
                  {{ getSyncStatusLabel(coord.metadata.syncStatus) }}
                </span>
                <span *ngIf="coord.metadata.isConnected" class="detail-badge connected-badge">Connected</span>
                <span *ngIf="!coord.metadata.isConnected" class="detail-badge offline-badge">Offline</span>
                <span class="detail-meta">v{{ coord.metadata.version }}</span>
              </div>

              <div class="detail-section">
                <h4 class="detail-section-title">Reservoir Readings</h4>
                <div class="detail-grid">
                  <div class="detail-cell">
                    <ng-icon hlmIcon name="lucideBeaker" size="xs" />
                    <span class="cell-label">pH</span>
                    <span class="cell-value">{{ coord.reported.ph ?? '--' }}</span>
                  </div>
                  <div class="detail-cell">
                    <ng-icon hlmIcon name="lucideZap" size="xs" />
                    <span class="cell-label">EC</span>
                    <span class="cell-value">{{ coord.reported.ecMsCm ?? '--' }} mS</span>
                  </div>
                  <div class="detail-cell">
                    <ng-icon hlmIcon name="lucideDroplet" size="xs" />
                    <span class="cell-label">TDS</span>
                    <span class="cell-value">{{ coord.reported.tdsPpm ?? '--' }} ppm</span>
                  </div>
                  <div class="detail-cell">
                    <ng-icon hlmIcon name="lucideThermometer" size="xs" />
                    <span class="cell-label">Water</span>
                    <span class="cell-value">{{ coord.reported.waterTempC ?? '--' }}&deg;C</span>
                  </div>
                  <div class="detail-cell">
                    <ng-icon hlmIcon name="lucideArrowUpDown" size="xs" />
                    <span class="cell-label">Level</span>
                    <span class="cell-value">{{ coord.reported.waterLevelPct ?? '--' }}%</span>
                  </div>
                  <div class="detail-cell">
                    <ng-icon hlmIcon name="lucideThermometer" size="xs" />
                    <span class="cell-label">Air</span>
                    <span class="cell-value">{{ coord.reported.tempC ?? '--' }}&deg;C</span>
                  </div>
                </div>
              </div>

              <div class="detail-section">
                <h4 class="detail-section-title">Pumps</h4>
                <div class="detail-grid cols-3">
                  <div class="detail-cell pump-cell" [class.active]="coord.reported.mainPumpOn">
                    <span class="pump-dot"></span>
                    <span class="cell-label">Main</span>
                  </div>
                  <div class="detail-cell pump-cell" [class.active]="coord.reported.dosingPumpPhOn">
                    <span class="pump-dot"></span>
                    <span class="cell-label">pH Dose</span>
                  </div>
                  <div class="detail-cell pump-cell" [class.active]="coord.reported.dosingPumpNutrientOn">
                    <span class="pump-dot"></span>
                    <span class="cell-label">Nutrient</span>
                  </div>
                </div>
              </div>

              <div class="detail-section">
                <h4 class="detail-section-title">System</h4>
                <div class="detail-kv">
                  <div class="kv-row"><span>Firmware</span><span>{{ coord.reported.fwVersion ?? '--' }}</span></div>
                  <div class="kv-row"><span>Uptime</span><span>{{ formatUptime(coord.reported.uptimeS) }}</span></div>
                  <div class="kv-row"><span>WiFi</span><span>{{ coord.reported.wifiRssi ?? '--' }} dBm</span></div>
                  <div class="kv-row"><span>Quality</span><span>{{ coord.metadata.connectionQuality }}%</span></div>
                  <div class="kv-row"><span>Towers Online</span><span>{{ coord.reported.towersOnline }}</span></div>
                </div>
              </div>
            </div>
          </ng-container>

          <!-- Tower Detail -->
          <ng-container *ngIf="selectedTowerTwin() as tower">
            <div class="detail-content">
              <div class="detail-header">
                <div class="detail-title-row">
                  <span class="chain-dot tower-dot lg"></span>
                  <div>
                    <h3 class="detail-title">{{ tower.name }}</h3>
                    <span class="detail-subtitle">{{ tower.towerId }} &middot; Tower</span>
                  </div>
                </div>
                <button class="detail-close" (click)="clearSelection()">
                  <ng-icon hlmIcon name="lucideX" size="sm" />
                </button>
              </div>

              <div class="detail-status-row">
                <span class="detail-badge" [class]="'sync-badge ' + getSyncStatusClass(tower.metadata.syncStatus)">
                  {{ getSyncStatusLabel(tower.metadata.syncStatus) }}
                </span>
                <span *ngIf="tower.metadata.isConnected" class="detail-badge connected-badge">Connected</span>
                <span *ngIf="!tower.metadata.isConnected" class="detail-badge offline-badge">Offline</span>
                <span *ngIf="tower.cropType" class="detail-badge crop-badge">
                  <ng-icon hlmIcon name="lucideLeaf" size="xs" />
                  {{ getCropName(tower.cropType) }}
                </span>
              </div>

              <div class="detail-section">
                <h4 class="detail-section-title">Sensors</h4>
                <div class="detail-grid">
                  <div class="detail-cell">
                    <ng-icon hlmIcon name="lucideThermometer" size="xs" />
                    <span class="cell-label">Temp</span>
                    <span class="cell-value">{{ tower.reported.airTempC ?? '--' }}&deg;C</span>
                  </div>
                  <div class="detail-cell">
                    <ng-icon hlmIcon name="lucideDroplet" size="xs" />
                    <span class="cell-label">Humidity</span>
                    <span class="cell-value">{{ tower.reported.humidityPct ?? '--' }}%</span>
                  </div>
                  <div class="detail-cell">
                    <ng-icon hlmIcon name="lucideSun" size="xs" />
                    <span class="cell-label">Light</span>
                    <span class="cell-value">{{ tower.reported.lightLux ?? '--' }} lx</span>
                  </div>
                  <div class="detail-cell">
                    <ng-icon hlmIcon name="lucideBattery" size="xs" />
                    <span class="cell-label">Battery</span>
                    <span class="cell-value">{{ tower.reported.vbatMv ?? '--' }} mV</span>
                  </div>
                  <div class="detail-cell">
                    <ng-icon hlmIcon name="lucideSignal" size="xs" />
                    <span class="cell-label">Signal</span>
                    <span class="cell-value">{{ tower.reported.signalQuality ?? '--' }}%</span>
                  </div>
                  <div class="detail-cell">
                    <ng-icon hlmIcon name="lucideClock" size="xs" />
                    <span class="cell-label">Uptime</span>
                    <span class="cell-value">{{ formatUptime(tower.reported.uptimeS) }}</span>
                  </div>
                </div>
              </div>

              <div class="detail-section">
                <h4 class="detail-section-title">Controls</h4>
                <div class="detail-grid cols-3">
                  <div class="detail-cell pump-cell" [class.active]="tower.reported.pumpOn">
                    <span class="pump-dot"></span>
                    <span class="cell-label">Pump</span>
                  </div>
                  <div class="detail-cell pump-cell" [class.active]="tower.reported.lightOn">
                    <span class="pump-dot"></span>
                    <span class="cell-label">Light</span>
                  </div>
                  <div class="detail-cell">
                    <ng-icon hlmIcon name="lucideSun" size="xs" />
                    <span class="cell-label">Brightness</span>
                    <span class="cell-value">{{ tower.reported.lightBrightness ?? '--' }}%</span>
                  </div>
                </div>
              </div>

              <ng-container *ngIf="tower.mlPredictions">
                <div class="detail-section">
                  <h4 class="detail-section-title">Growth Predictions</h4>
                  <div class="detail-kv">
                    <div class="kv-row"><span>Health Score</span><span class="kv-highlight">{{ formatHealthScore(tower.mlPredictions.healthScore) }}/100</span></div>
                    <div class="kv-row"><span>Height</span><span>{{ tower.lastHeightCm ?? '--' }} cm</span></div>
                    <div class="kv-row"><span>Predicted</span><span>{{ tower.mlPredictions.predictedHeightCm ?? '--' }} cm</span></div>
                    <div class="kv-row"><span>Growth Rate</span><span>{{ tower.mlPredictions.growthRateCmPerDay ?? '--' }} cm/d</span></div>
                    <div class="kv-row"><span>Days to Harvest</span><span>{{ tower.mlPredictions.daysToHarvest ?? '--' }}</span></div>
                    <div class="kv-row"><span>Confidence</span><span>{{ tower.mlPredictions.confidence ? (tower.mlPredictions.confidence * 100).toFixed(0) + '%' : '--' }}</span></div>
                  </div>
                </div>
              </ng-container>

              <div class="detail-section">
                <h4 class="detail-section-title">System</h4>
                <div class="detail-kv">
                  <div class="kv-row"><span>Firmware</span><span>{{ tower.reported.fwVersion ?? '--' }}</span></div>
                  <div class="kv-row"><span>Coordinator</span><span>{{ tower.coordId }}</span></div>
                  <div class="kv-row"><span>Quality</span><span>{{ tower.metadata.connectionQuality }}%</span></div>
                </div>
              </div>
            </div>
          </ng-container>

          <!-- Empty State (no selection) -->
          <ng-container *ngIf="!hasSelection()">
            <div class="detail-empty">
              <ng-icon hlmIcon name="lucideCircleDot" size="lg" />
              <span class="detail-empty-title">Select a device</span>
              <span class="detail-empty-hint">Click a reservoir or tower in the topology to view its details</span>
            </div>
          </ng-container>

        </div>
      </div>

      <!-- RIGHT: Topology Graph Card -->
      <div class="dashboard-card graph-card">
        <div class="graph-card-inner">
          @if (twinLoading()) {
            <hlm-skeleton class="full-skeleton" />
          } @else if (twinsByCoordinator().length === 0) {
            <div class="graph-empty">
              <ng-icon hlmIcon name="lucideGitBranch" size="lg" />
              <span>No twin data available</span>
              <button hlmBtn variant="ghost" size="sm" (click)="refreshData()">Refresh</button>
            </div>
          } @else {
            <!-- Farm Group — rendered as linked list -->
            <div class="farm-group">
              <span class="farm-group-label">Hydro Farm Alpha</span>

              @for (group of twinsByCoordinator(); track group.coordinator.coordId) {
                <div class="coord-chain">
                  <!-- Coordinator node -->
                  <button
                    class="chain-node coord"
                    [class.selected]="isNodeSelected('coordinator', group.coordinator.coordId)"
                    [class.connected]="group.coordinator.metadata.isConnected"
                    (click)="selectNode('coordinator', group.coordinator.coordId)">
                    <span class="chain-dot coord-dot"></span>
                    <span class="chain-name">{{ group.coordinator.name }}</span>
                  </button>

                  <!-- Arrow connector -->
                  <div class="chain-connector">
                    <svg viewBox="0 0 32 2" class="connector-line"><line x1="0" y1="1" x2="32" y2="1" /></svg>
                  </div>

                  <!-- Tower nodes -->
                  @for (tower of group.towers; track tower.towerId; let last = $last) {
                    <button
                      class="chain-node tower"
                      [class.selected]="isNodeSelected('tower', tower.towerId)"
                      [class.connected]="tower.metadata.isConnected"
                      (click)="selectNode('tower', tower.towerId)">
                      <span class="chain-dot tower-dot"></span>
                      <span class="chain-name">{{ tower.name }}</span>
                    </button>
                    @if (!last) {
                      <div class="chain-connector sibling">
                        <svg viewBox="0 0 20 2" class="connector-line sibling"><line x1="0" y1="1" x2="20" y2="1" /></svg>
                      </div>
                    }
                  }
                </div>
              }
            </div>

            <!-- Infra pills -->
            <div class="infra-overlay">
              <div class="infra-pill online">
                <ng-icon hlmIcon name="lucideServer" size="xs" /><span>API</span>
              </div>
              <div class="infra-pill online">
                <ng-icon hlmIcon name="lucideDatabase" size="xs" /><span>DB</span>
              </div>
              <div class="infra-pill" [class.online]="wsConnected()">
                <ng-icon hlmIcon name="lucideRadio" size="xs" /><span>MQTT</span>
              </div>
            </div>
          }
        </div>
      </div>
    </div>
  </section>

  <!-- System Health Sparklines -->
  <section class="system-health-section">
    <div class="system-health-header">
      <ng-icon hlmIcon name="lucideBarChart3" size="sm" />
      <span class="system-health-title">System Health</span>
    </div>
    <div class="system-health-grid">
      <app-telemetry-chart
        #avgPhChart
        title="Avg pH"
        unit="pH"
        color="#8b5cf6"
        [minY]="0"
        [maxY]="14"
        [thresholdLow]="5.5"
        [thresholdHigh]="7.5"
        height="120px"
      />
      <app-telemetry-chart
        #avgEcChart
        title="Avg EC"
        unit="mS/cm"
        color="#06b6d4"
        [minY]="0"
        [maxY]="5"
        [thresholdLow]="0.8"
        [thresholdHigh]="3.0"
        height="120px"
      />
      <app-telemetry-chart
        #avgWaterLevelChart
        title="Avg Water Level"
        unit="%"
        color="#3b82f6"
        [minY]="0"
        [maxY]="100"
        height="120px"
      />
    </div>
  </section>

  <!-- Alerts Section -->
  @if (activeAlerts().length > 0) {
    <section class="alerts-section-standalone">
      <div class="alerts-header">
        <h4 class="alerts-title">
          <ng-icon hlmIcon name="lucideAlertTriangle" size="sm" />
          Recent Alerts
        </h4>
        @if (activeAlerts().length > 5) {
          <a routerLink="/alerts" class="view-all-alerts">
            View all {{ activeAlerts().length }}
            <ng-icon hlmIcon name="lucideChevronRight" size="sm" />
          </a>
        }
      </div>
      <div class="alerts-scroll-container">
        <div class="alerts-scroll-content">
          @for (alert of activeAlerts(); track trackByAlertId($index, alert)) {
            <div class="alert-item" [class]="'alert-' + alert.severity">
              <ng-icon hlmIcon name="lucideAlertTriangle" size="sm" />
              <div class="alert-info">
                <span class="alert-message">{{ alert.message }}</span>
                <span class="alert-meta">{{ alert.source.name }} - {{ formatTimestamp(alert.createdAt) }}</span>
              </div>
              <span hlmBadge [variant]="getAlertBadgeVariant(alert.severity)" size="sm">
                {{ alert.severity }}
              </span>
            </div>
          }
        </div>
      </div>
    </section>
  }
</div>
