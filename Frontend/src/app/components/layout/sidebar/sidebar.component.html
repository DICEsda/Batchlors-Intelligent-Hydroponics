<aside class="sidebar" [class.collapsed]="collapsed()">
  <!-- Logo Section -->
  <div class="sidebar-header">
    <div class="logo-container">
      <div class="logo-icon">
        <ng-icon name="lucideCommand" size="20" />
      </div>
      @if (!collapsed()) {
        <div class="logo-text">
          <span class="company-name">SmartTile</span>
          <span class="company-tier">IoT System</span>
        </div>
      }
    </div>
  </div>

  <!-- Platform Navigation -->
  <nav class="sidebar-nav">
    <div class="nav-section">
      @if (!collapsed()) {
        <span class="nav-section-title">Platform</span>
      }
      
      @for (item of platformItems(); track item.label) {
        @if (item.children) {
          <!-- Expandable Item -->
          <div class="nav-item-group">
            <button 
              class="nav-item expandable"
              [class.expanded]="item.expanded"
              (click)="toggleExpand(item)"
              (mouseenter)="onNavItemHover(item, $event)"
              (mouseleave)="onNavItemLeave()"
            >
              <ng-icon [name]="item.icon" size="18" />
              @if (!collapsed()) {
                <span class="nav-label">{{ item.label }}</span>
                <ng-icon 
                  [name]="item.expanded ? 'lucideChevronDown' : 'lucideChevronRight'" 
                  size="16" 
                  class="chevron"
                />
              }
            </button>
            
            @if (item.expanded && !collapsed()) {
              <div class="nav-children">
                @for (child of item.children; track child.label) {
                  @if (child.children) {
                    <!-- Nested Expandable Item -->
                    <div class="nav-item-subgroup">
                      <a 
                        [routerLink]="child.route" 
                        routerLinkActive="active"
                        class="nav-item child expandable-child"
                        [class.expanded]="child.expanded"
                      >
                        <ng-icon [name]="child.icon" size="16" />
                        @if (!collapsed()) {
                          <span class="nav-label">{{ child.label }}</span>
                          <ng-icon 
                            [name]="child.expanded ? 'lucideChevronDown' : 'lucideChevronRight'" 
                            size="14" 
                            class="chevron"
                            (click)="toggleExpand(child); $event.preventDefault(); $event.stopPropagation()"
                          />
                        }
                      </a>
                      
                      @if (child.expanded) {
                        <div class="nav-grandchildren">
                          @for (grandchild of child.children; track grandchild.label) {
                            <a 
                              [routerLink]="grandchild.route" 
                              routerLinkActive="active"
                              class="nav-item grandchild"
                            >
                              <ng-icon [name]="grandchild.icon" size="14" />
                              @if (!collapsed()) {
                                <span class="nav-label">{{ grandchild.label }}</span>
                              }
                            </a>
                          }
                        </div>
                      }
                    </div>
                  } @else {
                    <!-- Regular Child Item -->
                    <a 
                      [routerLink]="child.route" 
                      routerLinkActive="active"
                      class="nav-item child"
                    >
                      <ng-icon [name]="child.icon" size="16" />
                      @if (!collapsed()) {
                        <span class="nav-label">{{ child.label }}</span>
                      }
                    </a>
                  }
                }
              </div>
            }
          </div>
        } @else {
          <!-- Single Item -->
          <a 
            [routerLink]="item.route" 
            routerLinkActive="active"
            class="nav-item"
            (mouseenter)="onNavItemHover(item, $event)"
            (mouseleave)="onNavItemLeave()"
          >
            <ng-icon [name]="item.icon" size="18" />
            @if (!collapsed()) {
              <span class="nav-label">{{ item.label }}</span>
            }
          </a>
        }
      }
    </div>

    <!-- Projects Section -->
    <div class="nav-section">
      @if (!collapsed()) {
        <span class="nav-section-title">Projects</span>
      }
      
      @for (project of projects(); track project.label) {
        <a 
          [routerLink]="project.route" 
          routerLinkActive="active"
          class="nav-item"
          (mouseenter)="onNavItemHover(project, $event)"
          (mouseleave)="onNavItemLeave()"
        >
          <ng-icon [name]="project.icon" size="18" />
          @if (!collapsed()) {
            <span class="nav-label">{{ project.label }}</span>
          }
        </a>
      }
    </div>

    <!-- Diagnostics Section -->
    <div class="nav-section">
      @if (!collapsed()) {
        <span class="nav-section-title">Diagnostics</span>
      }
      
      @for (item of diagnosticsItems(); track item.label) {
        @if (item.children) {
          <div class="nav-item-group">
            <button 
              class="nav-item expandable"
              [class.expanded]="item.expanded"
              (click)="toggleExpand(item)"
              (mouseenter)="onNavItemHover(item, $event)"
              (mouseleave)="onNavItemLeave()"
            >
              <ng-icon [name]="item.icon" size="18" />
              @if (!collapsed()) {
                <span class="nav-label">{{ item.label }}</span>
                <ng-icon 
                  [name]="item.expanded ? 'lucideChevronDown' : 'lucideChevronRight'" 
                  size="16" 
                  class="chevron"
                />
              }
            </button>
            
            @if (item.expanded && !collapsed()) {
              <div class="nav-children">
                @for (child of item.children; track child.label) {
                  <a 
                    [routerLink]="child.route" 
                    routerLinkActive="active"
                    class="nav-item child"
                  >
                    <ng-icon [name]="child.icon" size="16" />
                    @if (!collapsed()) {
                      <span class="nav-label">{{ child.label }}</span>
                    }
                  </a>
                }
              </div>
            }
          </div>
        }
      }
    </div>
  </nav>

  <!-- Bottom Section - System Status & User Account -->
  <div class="sidebar-footer">
    <!-- System Status Section -->
    <div class="system-status" [class.ws-offline]="!wsConnected()">
      @if (!collapsed()) {
        <span class="status-section-title">System Status</span>
      }

      <!-- Backend -->
      <div class="status-item" [title]="collapsed() ? ('Backend: ' + (backendConnected() ? 'Online' : 'Offline')) : ''">
        <div class="status-indicator" [class.online]="backendConnected()" [class.offline]="!backendConnected()">
          <span class="status-dot"></span>
        </div>
        <ng-icon name="lucideServer" size="14" />
        @if (!collapsed()) {
          <span class="status-label">Backend</span>
          <span class="status-value" [class.online]="backendConnected()">
            {{ backendConnected() ? 'Online' : 'Offline' }}
          </span>
        }
      </div>

      <!-- MongoDB -->
      <div class="status-item" [title]="collapsed() ? ('MongoDB: ' + (mongodbConnected() ? 'Connected' : 'Offline')) : ''">
        <div class="status-indicator" [class.online]="mongodbConnected()" [class.offline]="!mongodbConnected()">
          <span class="status-dot"></span>
        </div>
        <ng-icon name="lucideDatabase" size="14" />
        @if (!collapsed()) {
          <span class="status-label">MongoDB</span>
          <span class="status-value" [class.online]="mongodbConnected()">
            {{ mongodbConnected() ? 'Connected' : 'Offline' }}
          </span>
        }
      </div>

      <!-- MQTT Broker -->
      <div class="status-item" [title]="collapsed() ? ('MQTT: ' + (mqttBrokerConnected() ? 'Connected' : 'Offline')) : ''">
        <div class="status-indicator" [class.online]="mqttBrokerConnected()" [class.offline]="!mqttBrokerConnected()">
          <span class="status-dot"></span>
        </div>
        <ng-icon name="lucideRadio" size="14" />
        @if (!collapsed()) {
          <span class="status-label">MQTT Broker</span>
          <span class="status-value" [class.online]="mqttBrokerConnected()">
            {{ mqttBrokerConnected() ? 'Connected' : 'Offline' }}
          </span>
        }
      </div>

      <!-- ML Pipeline -->
      <div class="status-item" [title]="collapsed() ? ('ML: ' + (mlPipelineHealthy() ? 'Healthy' : 'Offline')) : ''">
        <div class="status-indicator" [class.online]="mlPipelineHealthy()" [class.offline]="!mlPipelineHealthy()">
          <span class="status-dot"></span>
        </div>
        <ng-icon name="lucideBrain" size="14" />
        @if (!collapsed()) {
          <span class="status-label">ML Pipeline</span>
          <span class="status-value" [class.online]="mlPipelineHealthy()">
            {{ mlPipelineHealthy() ? 'Healthy' : 'Offline' }}
          </span>
        }
      </div>

      <!-- Simulator -->
      <div class="status-item" [title]="collapsed() ? ('Simulator: ' + (simulatorActive() ? 'Active' : 'Inactive')) : ''">
        <div class="status-indicator" [class.online]="simulatorActive()" [class.offline]="!simulatorActive()">
          <span class="status-dot"></span>
        </div>
        <ng-icon name="lucideFlaskConical" size="14" />
        @if (!collapsed()) {
          <span class="status-label">Simulator</span>
          <span class="status-value" [class.online]="simulatorActive()">
            {{ simulatorActive() ? 'Active' : 'Inactive' }}
          </span>
        }
      </div>

      <!-- Separator -->
      @if (!collapsed()) {
        <div class="status-separator"></div>
      }

      <!-- Coordinators -->
      <div class="status-item" [title]="collapsed() ? ('Coordinators: ' + onlineCoordinators() + '/' + totalCoordinators()) : ''">
        <div class="status-indicator" [class.online]="onlineCoordinators() > 0" [class.offline]="onlineCoordinators() === 0">
          <span class="status-dot"></span>
        </div>
        <ng-icon name="lucideCpu" size="14" />
        @if (!collapsed()) {
          <span class="status-label">Coordinators</span>
          <span class="status-value" [class.online]="onlineCoordinators() > 0">
            {{ onlineCoordinators() }}/{{ totalCoordinators() }}
          </span>
        }
      </div>

      <!-- Towers -->
      <div class="status-item" [title]="collapsed() ? ('Towers: ' + onlineNodes() + '/' + totalNodes()) : ''">
        <div class="status-indicator" [class.online]="onlineNodes() > 0" [class.offline]="onlineNodes() === 0">
          <span class="status-dot"></span>
        </div>
        <ng-icon name="lucideLightbulb" size="14" />
        @if (!collapsed()) {
          <span class="status-label">Towers</span>
          <span class="status-value" [class.online]="onlineNodes() > 0">
            {{ onlineNodes() }}/{{ totalNodes() }}
          </span>
        }
      </div>
    </div>
    
    <!-- User Account / Role Switcher -->
    <div class="role-switcher" (clickOutside)="closeDropdown()">
      <button 
        class="role-button" 
        (click)="toggleRoleDropdown()"
        [title]="collapsed() ? currentRoleDisplay()?.label : ''"
      >
        <div class="role-icon">
          <ng-icon [name]="currentRoleDisplay()?.icon || 'lucideUser'" size="18" />
        </div>
        @if (!collapsed()) {
          <div class="role-info">
            <span class="role-title">{{ currentRoleDisplay()?.label }}</span>
            <span class="role-subtitle">Switch Role</span>
          </div>
          <ng-icon 
            name="lucideChevronDown" 
            size="16" 
            class="role-chevron"
            [class.rotated]="roleDropdownOpen()" 
          />
        }
      </button>
      
      @if (roleDropdownOpen()) {
        <div class="role-dropdown">
          @for (option of roleOptions; track option.value) {
            <button 
              class="role-option"
              [class.active]="currentRole() === option.value"
              (click)="selectRole(option.value)"
            >
              <ng-icon [name]="option.icon" size="16" />
              <span>{{ option.label }}</span>
              @if (currentRole() === option.value) {
                <span class="check-mark">âœ“</span>
              }
            </button>
          }
        </div>
      }
    </div>
  </div>

  <!-- Hover Popup for Collapsed Sidebar -->
  @if (collapsed() && hoveredItem()) {
    <div class="sidebar-hover-popup" 
         [style.top.px]="popupPosition() ? popupPosition()!.top : 0"
         (mouseenter)="onPopupEnter()" 
         (mouseleave)="onPopupLeave()">
      @if (hasChildren(hoveredItem()!)) {
        <!-- Show children menu -->
        <div class="popup-header">{{ hoveredItem()!.label }}</div>
        <div class="popup-children">
          @for (child of getChildren(hoveredItem()!); track child.label) {
            @if (child.route) {
              <a 
                [routerLink]="child.route" 
                routerLinkActive="active-popup"
                class="popup-child-item"
              >
                <ng-icon [name]="child.icon" size="16" />
                <span>{{ child.label }}</span>
              </a>
            }
            @if (child.children && child.children.length > 0) {
              <!-- Nested children -->
              @for (grandchild of child.children; track grandchild.label) {
                <a 
                  [routerLink]="grandchild.route" 
                  routerLinkActive="active-popup"
                  class="popup-child-item nested"
                >
                  <ng-icon [name]="grandchild.icon" size="14" />
                  <span>{{ grandchild.label }}</span>
                </a>
              }
            }
          }
        </div>
      } @else {
        <!-- Show just the label -->
        <div class="popup-label">{{ hoveredItem()!.label }}</div>
      }
    </div>
  }
</aside>
