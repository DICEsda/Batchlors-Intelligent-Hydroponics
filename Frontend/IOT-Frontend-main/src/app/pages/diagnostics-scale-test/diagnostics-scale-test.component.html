<!-- Page Header -->
<div class="flex items-center justify-between mb-6">
  <div class="flex items-center gap-3">
    <ng-icon hlmIcon name="lucideBarChart3" size="lg" class="text-primary" />
    <div>
      <h1 class="text-2xl font-bold tracking-tight">Scale Test</h1>
      <p class="text-sm text-muted-foreground">
        Record and visualize backend performance under simulated load
      </p>
    </div>
  </div>
  <div class="flex items-center gap-2">
    @if (isRecording()) {
      <span hlmBadge variant="error" class="gap-1.5">
        <span class="recording-dot"></span>
        Recording
      </span>
    } @else {
      <span hlmBadge variant="outline">Idle</span>
    }
  </div>
</div>

<!-- Controls Section -->
<div hlmCard class="controls-panel">
  <div class="control-group">
    <label for="towerCount">Tower Count</label>
    <input
      id="towerCount"
      type="number"
      min="1"
      max="10000"
      [ngModel]="towerCount()"
      (ngModelChange)="towerCount.set($event)"
      [disabled]="isRecording()"
    />
  </div>

  @if (!isRecording()) {
    <button hlmBtn variant="success" size="sm" (click)="startRecording()" class="gap-1.5">
      <ng-icon hlmIcon name="lucidePlay" size="sm" />
      Start Recording
    </button>
  } @else {
    <button hlmBtn variant="destructive" size="sm" (click)="stopRecording()" class="gap-1.5">
      <span class="recording-dot"></span>
      <ng-icon hlmIcon name="lucideSquare" size="sm" />
      Stop Recording
    </button>
  }

  <button hlmBtn variant="outline" size="sm" (click)="resetCounters()" class="gap-1.5">
    <ng-icon hlmIcon name="lucideRefreshCw" size="sm" />
    Reset Counters
  </button>

  <p class="instructions">
    Start the simulator with matching tower count, then start recording here.
    Stop when the test window is complete to capture a snapshot.
  </p>
</div>

<!-- Results List -->
@if (scaleTestResults().length > 0) {
  <div class="results-list" hlmCard>
    <div class="p-4 border-b border-border">
      <h2 class="section-title">
        <ng-icon hlmIcon name="lucideClock" size="sm" />
        Test Results ({{ scaleTestResults().length }})
      </h2>
    </div>

    @for (result of scaleTestResults(); track result.startedAt) {
      <div
        class="result-row"
        [class.selected]="isSelected(result)"
        (click)="selectResult(result)"
      >
        <ng-icon hlmIcon name="lucideChevronRight" size="sm" class="text-muted-foreground" />
        <div class="flex-1 min-w-0">
          <div class="font-medium text-sm truncate">
            {{ formatTimestamp(result.startedAt) }}
          </div>
          <div class="result-meta">
            {{ result.towerCount }} towers &middot; {{ formatDuration(result.durationSeconds) }}
          </div>
        </div>
        <div class="text-right">
          <div class="text-sm font-semibold text-cyan-400">
            {{ result.peakThroughput }} msg/s
          </div>
          <div class="result-meta">
            avg {{ result.avgHandlerMs }}ms
          </div>
        </div>
        <button
          hlmBtn
          variant="ghost"
          size="icon"
          class="h-7 w-7 shrink-0"
          (click)="deleteResult(result, $event)"
        >
          <ng-icon hlmIcon name="lucideTrash2" size="xs" class="text-muted-foreground" />
        </button>
      </div>
    }
  </div>
}

<!-- Selected Result Detail -->
@if (selectedResult(); as result) {
  <!-- Summary Stats -->
  <div class="mb-4">
    <h2 class="section-title">
      <ng-icon hlmIcon name="lucideZap" size="sm" />
      Summary &mdash; {{ result.towerCount }} Towers, {{ formatDuration(result.durationSeconds) }}
    </h2>
  </div>

  <div class="stat-grid">
    <div hlmCard class="stat-card">
      <div class="stat-label">Peak msg/s</div>
      <div class="stat-value text-cyan-400">{{ result.peakThroughput }}</div>
    </div>
    <div hlmCard class="stat-card">
      <div class="stat-label">Avg msg/s</div>
      <div class="stat-value text-cyan-300">{{ result.avgThroughput }}</div>
    </div>
    <div hlmCard class="stat-card">
      <div class="stat-label">Avg Latency</div>
      <div class="stat-value text-amber-400">{{ result.avgHandlerMs }} ms</div>
    </div>
    <div hlmCard class="stat-card">
      <div class="stat-label">P95 Latency</div>
      <div class="stat-value text-amber-300">{{ result.p95HandlerMs }} ms</div>
    </div>
    <div hlmCard class="stat-card">
      <div class="stat-label">P99 Latency</div>
      <div class="stat-value text-orange-400">{{ result.p99HandlerMs }} ms</div>
    </div>
    <div hlmCard class="stat-card">
      <div class="stat-label">Total Messages</div>
      <div class="stat-value">{{ result.totalMessages | number }}</div>
    </div>
    <div hlmCard class="stat-card">
      <div class="stat-label">Total Errors</div>
      <div class="stat-value" [class.text-red-400]="result.totalErrors > 0" [class.text-green-400]="result.totalErrors === 0">
        {{ result.totalErrors }}
      </div>
    </div>
    <div hlmCard class="stat-card">
      <div class="stat-label">Duration</div>
      <div class="stat-value">{{ formatDuration(result.durationSeconds) }}</div>
    </div>
  </div>

  <!-- Charts -->
  <div class="chart-grid">
    <!-- Throughput over time -->
    @if (throughputChartOptions(); as opts) {
      <div hlmCard class="chart-card">
        <div class="chart-title">
          <ng-icon hlmIcon name="lucideZap" size="xs" class="inline-block mr-1 text-cyan-400" />
          Throughput over Time
        </div>
        <div echarts [options]="opts" class="chart"></div>
      </div>
    }

    <!-- Latency breakdown over time -->
    @if (latencyChartOptions(); as opts) {
      <div hlmCard class="chart-card">
        <div class="chart-title">
          <ng-icon hlmIcon name="lucideClock" size="xs" class="inline-block mr-1 text-amber-400" />
          Latency Breakdown over Time
        </div>
        <div echarts [options]="opts" class="chart"></div>
      </div>
    }

    <!-- Error timeline (full width) -->
    @if (errorChartOptions(); as opts) {
      <div hlmCard class="chart-card col-span-full">
        <div class="chart-title">
          <ng-icon hlmIcon name="lucideAlertTriangle" size="xs" class="inline-block mr-1 text-red-400" />
          Error Timeline (cumulative)
        </div>
        <div echarts [options]="opts" class="chart"></div>
      </div>
    }
  </div>
}

<!-- Empty state -->
@if (scaleTestResults().length === 0 && !isRecording()) {
  <div hlmCard class="flex flex-col items-center justify-center py-16 text-center">
    <ng-icon hlmIcon name="lucideBarChart3" size="xl" class="text-muted-foreground mb-4 opacity-40" />
    <h3 class="text-lg font-semibold text-muted-foreground mb-1">No Scale Tests Yet</h3>
    <p class="text-sm text-muted-foreground max-w-md">
      Set the tower count, start the simulator backend, and click
      <strong>Start Recording</strong> to capture your first scale test.
    </p>
  </div>
}
