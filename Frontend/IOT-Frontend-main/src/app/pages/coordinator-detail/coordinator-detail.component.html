<div class="coordinator-detail">
  <!-- Header with back navigation -->
  <header class="page-header">
    <div class="header-left">
      <a routerLink="/overview" hlmBtn variant="ghost" size="icon" class="back-btn">
        <ng-icon hlmIcon name="lucideArrowLeft" size="sm" />
      </a>
      <div class="header-content">
        @if (loading()) {
          <hlm-skeleton class="title-skeleton" />
        } @else {
          <h1 class="page-title">{{ coordinator()?.name || 'Coordinator' }}</h1>
          <p class="page-description">
            @if (coordinator()) {
              <span hlmBadge [variant]="getStatusBadgeVariant(coordinatorStatus())">
                <ng-icon hlmIcon [name]="coordinatorStatus() === 'online' ? 'lucideWifi' : 'lucideWifiOff'" size="xs" />
                {{ coordinatorStatus() }}
              </span>
              <span class="separator">|</span>
              <span>{{ onlineNodeCount() }}/{{ totalNodeCount() }} nodes online</span>
            }
          </p>
        }
      </div>
    </div>
    <div class="header-actions">
      <span
        hlmBadge
        [variant]="wsConnected() ? 'outline' : 'destructive'"
        class="live-badge"
      >
        <span class="live-dot" [class.active]="wsConnected()"></span>
        {{ wsConnected() ? 'Live' : 'Offline' }}
      </span>
      
      <!-- Pairing Button -->
      @if (isPairing()) {
        <button 
          hlmBtn 
          variant="secondary" 
          size="sm" 
          class="pairing-active-btn"
          (click)="cancelPairing()"
        >
          <ng-icon hlmIcon name="lucideLoader2" size="sm" class="animate-spin" />
          Pairing {{ formatPairingCountdown() }}
        </button>
      } @else {
        <button 
          hlmBtn 
          variant="default" 
          size="sm"
          (click)="startPairing()"
          [disabled]="!coordinator()"
        >
          <ng-icon hlmIcon name="lucideRadio" size="sm" />
          Start Pairing
        </button>
      }
      
      <button hlmBtn variant="outline" size="sm" (click)="refreshData()">
        <ng-icon hlmIcon name="lucideRefreshCw" size="sm" />
        Refresh
      </button>
      <button hlmBtn variant="outline" size="sm">
        <ng-icon hlmIcon name="lucideSettings" size="sm" />
        Settings
      </button>
    </div>
  </header>

  <!-- Error State -->
  @if (error()) {
    <div class="error-banner">
      <ng-icon hlmIcon name="lucideAlertTriangle" size="sm" />
      <span>{{ error() }}</span>
      <button hlmBtn variant="ghost" size="sm" (click)="refreshData()">Retry</button>
    </div>
  }

  <!-- Pairing Error -->
  @if (pairingError()) {
    <div class="error-banner pairing-error">
      <ng-icon hlmIcon name="lucideAlertTriangle" size="sm" />
      <span>Pairing failed: {{ pairingError() }}</span>
      <button hlmBtn variant="ghost" size="sm" (click)="pairingError.set(null)">Dismiss</button>
    </div>
  }

  <!-- Pairing Mode Banner -->
  @if (isPairing()) {
    <div class="pairing-banner">
      <div class="pairing-banner-content">
        <ng-icon hlmIcon name="lucideRadio" size="lg" class="pairing-icon animate-pulse" />
        <div class="pairing-info">
          <h3>Pairing Mode Active</h3>
          <p>Put new nodes into pairing mode to connect them to this coordinator.</p>
        </div>
      </div>
      <div class="pairing-timer">
        <span class="timer-value">{{ formatPairingCountdown() }}</span>
        <span class="timer-label">remaining</span>
      </div>
      <button hlmBtn variant="outline" size="sm" (click)="cancelPairing()">
        Cancel
      </button>
    </div>
  }

  <!-- Discovered Towers Section (visible during pairing or when towers are discovered) -->
  @if (isPairing() || discoveredTowers().length > 0) {
    <section class="discovered-nodes-section">
      <div class="section-header">
        <h2 class="section-title">
          <ng-icon hlmIcon name="lucideRadio" size="sm" class="section-icon" />
          Discovered Towers
        </h2>
        @if (discoveredTowers().length > 0) {
          <span hlmBadge variant="secondary">{{ discoveredTowers().length }} found</span>
        }
      </div>

      @if (discoveredTowers().length === 0) {
        <div class="empty-discovered">
          <ng-icon hlmIcon name="lucideRadar" size="xl" class="animate-pulse" />
          <h3>Scanning for towers...</h3>
          <p>Put new towers into pairing mode. They will appear here when discovered.</p>
        </div>
      } @else {
        <div class="discovered-nodes-grid">
          @for (tower of discoveredTowers(); track trackByDiscoveredTowerId($index, tower)) {
            <div hlmCard class="discovered-node-card" [class.paired]="tower.status === 'paired'" [class.error]="tower.status === 'error'" [class.rejected]="tower.status === 'rejected'">
              <div hlmCardHeader class="discovered-node-header">
                <div class="node-info">
                  <span hlmCardTitle class="node-id">{{ tower.towerId }}</span>
                  <span hlmCardDescription class="mac-address">{{ tower.macAddress }}</span>
                </div>
                <span hlmBadge [variant]="getDiscoveredTowerBadgeVariant(tower.status)" size="sm">
                  @if (tower.status === 'pairing') {
                    <ng-icon hlmIcon name="lucideLoader2" size="xs" class="animate-spin" />
                  }
                  {{ tower.status }}
                </span>
              </div>
              <div hlmCardContent class="discovered-node-content">
                <div class="node-details">
                  <div class="detail">
                    <ng-icon hlmIcon name="lucideWifi" size="xs" />
                    <span>RSSI: {{ tower.rssi }} dBm</span>
                  </div>
                  @if (tower.firmwareVersion) {
                    <div class="detail">
                      <ng-icon hlmIcon name="lucideCpu" size="xs" />
                      <span>FW: {{ tower.firmwareVersion }}</span>
                    </div>
                  }
                  <div class="detail">
                    <ng-icon hlmIcon name="lucideClock" size="xs" />
                    <span>{{ formatTimeAgo(tower.discoveredAt) }}</span>
                  </div>
                </div>
                
                @if (tower.error) {
                  <div class="node-error">
                    <ng-icon hlmIcon name="lucideAlertTriangle" size="xs" />
                    <span>{{ tower.error }}</span>
                  </div>
                }
              </div>
              
              <!-- Action buttons - only show for discovered status -->
              @if (tower.status === 'discovered') {
                <div class="discovered-node-actions">
                  <button hlmBtn variant="default" size="sm" (click)="approveTower(tower)">
                    <ng-icon hlmIcon name="lucideRadio" size="sm" />
                    Approve
                  </button>
                  <button hlmBtn variant="ghost" size="sm" (click)="rejectTower(tower)">
                    Reject
                  </button>
                </div>
              }
              
              @if (tower.status === 'paired') {
                <div class="discovered-node-success">
                  <ng-icon hlmIcon name="lucideRadio" size="sm" />
                  <span>Successfully paired!</span>
                </div>
              }
            </div>
          }
        </div>
      }
    </section>
  }

  <!-- Loading State -->
  @if (loading()) {
    <div class="loading-grid">
      @for (i of [1, 2, 3, 4]; track i) {
        <div hlmCard class="metric-card">
          <hlm-skeleton class="metric-skeleton" />
        </div>
      }
    </div>
  } @else if (coordinator()) {
    <!-- Coordinator Info Section -->
    <section class="coordinator-info-section">
      <h2 class="section-title">Coordinator Information</h2>
      <div class="info-grid">
        <!-- Coordinator ID -->
        <div hlmCard class="info-card">
          <div hlmCardHeader class="info-header">
            <ng-icon hlmIcon name="lucideServer" size="lg" class="info-icon" />
            <div class="info-content">
              <span hlmCardDescription>Coordinator ID</span>
              <span hlmCardTitle class="info-value">{{ coordinator()!.coord_id }}</span>
            </div>
          </div>
        </div>

        <!-- Firmware Version -->
        <div hlmCard class="info-card">
          <div hlmCardHeader class="info-header">
            <ng-icon hlmIcon name="lucideCpu" size="lg" class="info-icon" />
            <div class="info-content">
              <span hlmCardDescription>Firmware</span>
              <span hlmCardTitle class="info-value">{{ coordinator()!.fw_version || 'Unknown' }}</span>
            </div>
          </div>
        </div>

        <!-- IP Address -->
        @if (coordinator()!.ip_address) {
          <div hlmCard class="info-card">
            <div hlmCardHeader class="info-header">
              <ng-icon hlmIcon name="lucideWifi" size="lg" class="info-icon" />
              <div class="info-content">
                <span hlmCardDescription>IP Address</span>
                <span hlmCardTitle class="info-value">{{ coordinator()!.ip_address }}</span>
              </div>
            </div>
          </div>
        }

      </div>
    </section>

    <!-- Sensor Metrics Section -->
    <section class="metrics-section">
      <h2 class="section-title">Sensor Readings</h2>
      <div class="metrics-grid">
        <!-- Temperature -->
        <div hlmCard class="metric-card">
          <div hlmCardHeader class="metric-header">
            <ng-icon hlmIcon name="lucideThermometer" size="lg" class="metric-icon temp" />
            <div class="metric-info">
              <span hlmCardDescription>Temperature</span>
              <span hlmCardTitle class="metric-value">
                {{ coordinator()!.temp_c !== undefined ? coordinator()!.temp_c.toFixed(1) : '--' }}°C
              </span>
            </div>
          </div>
        </div>

        <!-- Light Level -->
        <div hlmCard class="metric-card">
          <div hlmCardHeader class="metric-header">
            <ng-icon hlmIcon name="lucideSun" size="lg" class="metric-icon light" />
            <div class="metric-info">
              <span hlmCardDescription>Ambient Light</span>
              <span hlmCardTitle class="metric-value">
                {{ coordinator()!.light_lux !== undefined ? coordinator()!.light_lux.toFixed(0) : '--' }} lux
              </span>
            </div>
          </div>
        </div>

        <!-- WiFi Signal -->
        <div hlmCard class="metric-card">
          <div hlmCardHeader class="metric-header">
            <ng-icon hlmIcon name="lucideWifi" size="lg" class="metric-icon signal" />
            <div class="metric-info">
              <span hlmCardDescription>WiFi Signal</span>
              <span hlmCardTitle class="metric-value">
                {{ coordinator()!.wifi_rssi || '--' }} dBm
              </span>
            </div>
          </div>
          <div hlmCardContent class="metric-content">
            <span class="signal-strength" [class]="'strength-' + signalStrength()">
              {{ signalStrength() }}
            </span>
          </div>
        </div>

      </div>

      <!-- Last update timestamp -->
      <div class="last-update">
        <ng-icon hlmIcon name="lucideClock" size="xs" />
        <span>Last seen: {{ formatTimeAgo(coordinator()!.last_seen) }}</span>
        @if (wsConnected()) {
          <span hlmBadge variant="outline" class="live-indicator">
            <ng-icon hlmIcon name="lucideZap" size="xs" />
            Real-time
          </span>
        }
      </div>
    </section>

    <!-- Telemetry Charts Section -->
    <section class="telemetry-section">
      <h2 class="section-title">
        <ng-icon hlmIcon name="lucideBarChart3" size="sm" class="section-icon" />
        Telemetry
      </h2>
      <div class="telemetry-grid">
        <app-telemetry-chart
          #phChart
          title="pH Level"
          unit="pH"
          color="#8b5cf6"
          [minY]="0"
          [maxY]="14"
          [thresholdLow]="5.5"
          [thresholdHigh]="7.5"
          height="200px"
        />
        <app-telemetry-chart
          #ecChart
          title="EC (mS/cm)"
          unit="mS/cm"
          color="#06b6d4"
          [minY]="0"
          [maxY]="5"
          [thresholdLow]="0.8"
          [thresholdHigh]="3.0"
          height="200px"
        />
        <app-telemetry-chart
          #waterLevelChart
          title="Water Level"
          unit="%"
          color="#3b82f6"
          [minY]="0"
          [maxY]="100"
          height="200px"
        />
        <app-telemetry-chart
          #waterTempChart
          title="Water Temperature"
          unit="°C"
          color="#f97316"
          [minY]="10"
          [maxY]="40"
          height="200px"
        />
      </div>
    </section>

    <!-- Connected Nodes Section -->
    <section class="nodes-section">
      <div class="section-header">
        <h2 class="section-title">Connected Nodes</h2>
        <div class="node-counts">
          <span hlmBadge variant="default">{{ onlineNodeCount() }} online</span>
          @if (pairingNodeCount() > 0) {
            <span hlmBadge variant="secondary">{{ pairingNodeCount() }} pairing</span>
          }
          @if (errorNodeCount() > 0) {
            <span hlmBadge variant="destructive">{{ errorNodeCount() }} error</span>
          }
        </div>
      </div>

      @if (connectedNodes().length === 0) {
        <div class="empty-state">
          <ng-icon hlmIcon name="lucideLightbulb" size="xl" />
          <h3>No Towers Connected Yet</h3>
          <p>Start pairing mode and activate your tower devices to connect them to this coordinator. They'll appear here once paired.</p>
          @if (!isPairing()) {
            <div class="empty-state-actions">
              <button hlmBtn variant="default" (click)="startPairing()">
                <ng-icon hlmIcon name="lucideRadio" size="sm" />
                Start Pairing Mode
              </button>
              <button hlmBtn variant="outline" routerLink="/settings">
                <ng-icon hlmIcon name="lucideInfo" size="sm" />
                Pairing Guide
              </button>
            </div>
          } @else {
            <span hlmBadge variant="secondary" class="pairing-badge">
              <ng-icon hlmIcon name="lucideLoader2" size="xs" class="animate-spin" />
              Pairing active - {{ formatPairingCountdown() }} remaining
            </span>
          }
        </div>
      } @else {
        <div class="nodes-grid">
          @for (node of connectedNodes(); track trackByNodeId($index, node)) {
            <div hlmCard class="node-card" [class.offline]="node.status_mode === 'error'">
              <div hlmCardHeader>
                <div class="card-header-row">
                  <a [routerLink]="['/nodes', node._id]" class="node-title-link">
                    <span hlmCardTitle>{{ node.name || node.light_id }}</span>
                  </a>
                  <span hlmBadge [variant]="getNodeStatusBadgeVariant(node.status_mode)" size="sm">
                    {{ node.status_mode }}
                  </span>
                </div>
                <span hlmCardDescription>ID: {{ node.light_id }}</span>
              </div>
              <div hlmCardContent class="node-metrics">
                <div class="metric">
                  <ng-icon hlmIcon name="lucideThermometer" size="xs" />
                  <span class="metric-value">{{ node.temp_c !== undefined ? node.temp_c.toFixed(1) : '--' }}°C</span>
                </div>
                <div class="metric">
                  <ng-icon hlmIcon name="lucideBattery" size="xs" />
                  <span class="metric-value" [class]="'battery-' + getBatteryStatus(node.vbat_mv)">
                    {{ getBatteryPercent(node.vbat_mv) }}%
                  </span>
                </div>
              </div>
              <div class="card-footer">
                <span class="last-seen">{{ formatTimeAgo(node.last_seen) }}</span>
                <div class="node-actions">
                  <button 
                    hlmBtn 
                    variant="ghost" 
                    size="sm" 
                    class="forget-btn"
                    (click)="forgetDevice(node); $event.preventDefault(); $event.stopPropagation()"
                    title="Forget this device"
                  >
                    <ng-icon hlmIcon name="lucideRadio" size="xs" />
                    Forget
                  </button>
                  <a [routerLink]="['/nodes', node._id]" hlmBtn variant="ghost" size="icon">
                    <ng-icon hlmIcon name="lucideChevronRight" size="sm" />
                  </a>
                </div>
              </div>
            </div>
          }
        </div>
      }
    </section>

    <!-- Serial Log Panel -->
    <section class="mt-6">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">Serial Logs</h2>
        <span class="text-sm text-muted-foreground">Live from coordinator</span>
      </div>
      <div class="bg-gray-950 rounded-lg p-4 font-mono text-xs max-h-80 overflow-y-auto" #logContainer>
        @for (entry of logs(); track entry.timestamp) {
          <div class="flex gap-2 py-0.5"
               [class]="entry.level === 'ERROR' ? 'text-red-400' : entry.level === 'WARN' ? 'text-yellow-400' : entry.level === 'DEBUG' ? 'text-gray-500' : 'text-green-400'">
            <span class="text-gray-600 shrink-0">{{ entry.timestamp | date:'HH:mm:ss' }}</span>
            <span class="shrink-0 w-12">{{ entry.level }}</span>
            <span class="text-gray-400 shrink-0">[{{ entry.tag }}]</span>
            <span>{{ entry.message }}</span>
          </div>
        } @empty {
          <div class="text-gray-600 italic">Waiting for serial log data...</div>
        }
      </div>
    </section>
  }
</div>
