<div class="digital-twin-page">
  <!-- Header -->
  <header class="page-header">
    <a routerLink="/overview" hlmBtn variant="ghost" size="icon" class="back-btn">
      <ng-icon hlmIcon name="lucideArrowLeft" size="sm" />
    </a>
    <div class="header-content">
      <h1 class="page-title">Digital Twin</h1>
      <p class="page-description">Real-time twin state of your hydroponic farm</p>
    </div>
    <div class="header-actions">
      <button hlmBtn variant="outline" size="sm" (click)="refresh()" [disabled]="isLoading()">
        <ng-icon hlmIcon name="lucideRefreshCw" size="sm" [class.spinning]="isLoading()" />
        Refresh
      </button>
    </div>
  </header>

  <!-- Error Banner -->
  @if (error()) {
    <div class="error-banner">
      <ng-icon hlmIcon name="lucideAlertTriangle" size="sm" />
      <span>{{ error() }}</span>
    </div>
  }

  <!-- Tabs: 3D View / Data View -->
  <hlm-tabs [defaultValue]="'3d'" class="twin-tabs">
    <div hlmTabsList class="tabs-list">
      <button hlmTabsTrigger value="3d"
        [isActive]="activeTab() === '3d'"
        (activated)="onTabChange($event)">
        <ng-icon hlmIcon name="lucideBox" size="sm" class="tab-icon" />
        3D View
      </button>
      <button hlmTabsTrigger value="data"
        [isActive]="activeTab() === 'data'"
        (activated)="onTabChange($event)">
        <ng-icon hlmIcon name="lucideTable" size="sm" class="tab-icon" />
        Data View
      </button>
    </div>

    <!-- ============================================ -->
    <!-- TAB 1: 3D View                              -->
    <!-- ============================================ -->
    <div hlmTabsContent value="3d" [isActive]="activeTab() === '3d'" class="tab-content-3d">
      <!-- Coordinator selector -->
      <div class="view-toolbar">
        <label class="selector-label">
          <ng-icon hlmIcon name="lucideServer" size="sm" />
          Coordinator:
        </label>
        <select
          class="coord-select"
          (change)="onCoordinatorSelect($any($event.target).value)">
          <option value="">All coordinators</option>
          @for (coord of coordTwins(); track coord.coordId) {
            <option [value]="coord.coordId">
              {{ coord.name || coord.coordId }}
            </option>
          }
        </select>
      </div>

      @if (isLoading() && coordTwins().length === 0) {
        <div class="loading-message">
          <ng-icon hlmIcon name="lucideRefreshCw" size="lg" class="spinning" />
          <span>Loading digital twins...</span>
        </div>
      } @else {
        <div class="scene-layout">
          <!-- 3D Canvas -->
          <div class="scene-canvas-wrapper">
            <app-tower-rack-3d
              [towers]="filteredTowers()"
              [alerts]="filteredAlerts()"
              (towerSelected)="onTowerSelected($event)"
            />
          </div>

          <!-- Side panel: selected tower details -->
          @if (selectedTowerDetail(); as tower) {
            <aside class="tower-detail-panel" hlmCard>
              <div class="detail-header">
                <h3 class="detail-title">{{ tower.name || tower.towerId }}</h3>
                <span hlmBadge [variant]="tower.metadata.isConnected ? 'default' : 'outline'" class="connection-badge">
                  <ng-icon hlmIcon [name]="tower.metadata.isConnected ? 'lucideWifi' : 'lucideWifiOff'" size="xs" />
                  {{ tower.metadata.isConnected ? 'Online' : 'Offline' }}
                </span>
              </div>

              @if (tower.metadata.syncStatus) {
                <div class="detail-sync">
                  <span hlmBadge [variant]="getSyncBadgeVariant(tower.metadata.syncStatus)" class="sync-badge-sm">
                    {{ formatSyncLabel(tower.metadata.syncStatus) }}
                  </span>
                </div>
              }

              <div class="detail-sensors">
                @if (tower.reported.airTempC != null) {
                  <div class="detail-sensor-row">
                    <ng-icon hlmIcon name="lucideThermometer" size="sm" />
                    <span class="detail-sensor-label">Temperature</span>
                    <span class="detail-sensor-value">{{ formatTemp(tower.reported.airTempC) }}&deg;C</span>
                  </div>
                }
                @if (tower.reported.humidityPct != null) {
                  <div class="detail-sensor-row">
                    <ng-icon hlmIcon name="lucideDroplet" size="sm" />
                    <span class="detail-sensor-label">Humidity</span>
                    <span class="detail-sensor-value">{{ formatPercent(tower.reported.humidityPct) }}</span>
                  </div>
                }
                @if (tower.reported.lightLux != null) {
                  <div class="detail-sensor-row">
                    <ng-icon hlmIcon name="lucideSun" size="sm" />
                    <span class="detail-sensor-label">Light</span>
                    <span class="detail-sensor-value">{{ formatNumber(tower.reported.lightLux, 0) }} lx</span>
                  </div>
                }
                @if (tower.reported.vbatMv != null) {
                  <div class="detail-sensor-row">
                    <ng-icon hlmIcon name="lucideBattery" size="sm" />
                    <span class="detail-sensor-label">Battery</span>
                    <span class="detail-sensor-value">{{ formatNumber(tower.reported.vbatMv, 0) }} mV</span>
                  </div>
                }
              </div>

              @if (tower.mlPredictions?.healthScore != null) {
                <div class="detail-health">
                  <ng-icon hlmIcon name="lucideLeaf" size="sm" class="health-icon" />
                  <span class="health-label">Health Score</span>
                  <span class="health-value">{{ formatHealthScore(tower.mlPredictions!.healthScore) }}</span>
                </div>
              }

              @if (tower.cropType) {
                <div class="detail-crop">
                  <ng-icon hlmIcon name="lucideFlower2" size="sm" />
                  <span>{{ tower.cropType }}</span>
                  @if (tower.mlPredictions?.daysToHarvest != null) {
                    <span class="harvest-eta">
                      <ng-icon hlmIcon name="lucideClock" size="xs" />
                      {{ tower.mlPredictions!.daysToHarvest }}d
                    </span>
                  }
                </div>
              }
            </aside>
          }
        </div>
      }
    </div>

    <!-- ============================================ -->
    <!-- TAB 2: Data View (existing card layout)     -->
    <!-- ============================================ -->
    <div hlmTabsContent value="data" [isActive]="activeTab() === 'data'" class="tab-content-data">
      @if (isLoading() && coordTwins().length === 0) {
        <div class="loading-message">
          <ng-icon hlmIcon name="lucideRefreshCw" size="lg" class="spinning" />
          <span>Loading digital twins...</span>
        </div>
      } @else if (coordTwins().length === 0 && !isLoading()) {
        <div class="empty-message">
          <ng-icon hlmIcon name="lucideServer" size="lg" />
          <span>No coordinator twins found. Register a coordinator to see its digital twin.</span>
        </div>
      } @else {
        <section class="twin-list">
          @for (coord of coordTwins(); track coord.coordId) {
            <div class="coordinator-card" hlmCard [class.expanded]="isCoordExpanded(coord.coordId)">
              <!-- Clickable Header -->
              <button class="coord-toggle" (click)="toggleCoord(coord.coordId)">
                <div class="coord-toggle-left">
                  <ng-icon hlmIcon
                    [name]="isCoordExpanded(coord.coordId) ? 'lucideChevronDown' : 'lucideChevronRight'"
                    size="sm"
                    class="chevron-icon" />
                  <ng-icon hlmIcon name="lucideServer" size="sm" />
                  <span class="coord-name">{{ coord.name || coord.coordId }}</span>
                  <span class="coord-id">{{ coord.coordId }}</span>
                </div>
                <div class="coord-toggle-right">
                  <!-- Compact sensor summary (always visible) -->
                  <div class="coord-summary">
                    @if (coord.reported.ph != null) {
                      <span class="summary-chip">pH {{ formatNumber(coord.reported.ph) }}</span>
                    }
                    @if (coord.reported.ecMsCm != null) {
                      <span class="summary-chip">EC {{ formatNumber(coord.reported.ecMsCm) }}</span>
                    }
                    @if (coord.reported.waterLevelPct != null) {
                      <span class="summary-chip">{{ formatPercent(coord.reported.waterLevelPct) }}</span>
                    }
                  </div>
                  <div class="coord-badges">
                    <span hlmBadge [variant]="coord.metadata.isConnected ? 'default' : 'outline'" class="connection-badge">
                      <ng-icon hlmIcon [name]="coord.metadata.isConnected ? 'lucideWifi' : 'lucideWifiOff'" size="xs" />
                      {{ coord.metadata.isConnected ? 'Online' : 'Offline' }}
                    </span>
                    @if (coord.metadata.syncStatus) {
                      <span hlmBadge [variant]="getSyncBadgeVariant(coord.metadata.syncStatus)">
                        {{ formatSyncLabel(coord.metadata.syncStatus) }}
                      </span>
                    }
                    <span class="tower-count-badge">
                      <ng-icon hlmIcon name="lucideLayoutGrid" size="xs" />
                      {{ getTowersForCoord(coord.coordId).length }}
                    </span>
                  </div>
                </div>
              </button>

              <!-- Collapsible Content -->
              @if (isCoordExpanded(coord.coordId)) {
                <div class="coord-body">
                  <!-- Coordinator Reported State -->
                  <div class="sensor-grid">
                    @if (coord.reported.ph != null) {
                      <div class="sensor-item">
                        <ng-icon hlmIcon name="lucideDroplet" size="sm" />
                        <span class="sensor-label">pH</span>
                        <span class="sensor-value">{{ formatNumber(coord.reported.ph) }}</span>
                      </div>
                    }
                    @if (coord.reported.ecMsCm != null) {
                      <div class="sensor-item">
                        <ng-icon hlmIcon name="lucideActivity" size="sm" />
                        <span class="sensor-label">EC</span>
                        <span class="sensor-value">{{ formatNumber(coord.reported.ecMsCm) }} mS</span>
                      </div>
                    }
                    @if (coord.reported.waterTempC != null) {
                      <div class="sensor-item">
                        <ng-icon hlmIcon name="lucideThermometer" size="sm" />
                        <span class="sensor-label">Water</span>
                        <span class="sensor-value">{{ formatTemp(coord.reported.waterTempC) }}&deg;C</span>
                      </div>
                    }
                    @if (coord.reported.waterLevelPct != null) {
                      <div class="sensor-item">
                        <ng-icon hlmIcon name="lucideGauge" size="sm" />
                        <span class="sensor-label">Level</span>
                        <span class="sensor-value">{{ formatPercent(coord.reported.waterLevelPct) }}</span>
                      </div>
                    }
                  </div>

                  <!-- Tower Twins for this Coordinator -->
                  @if (getTowersForCoord(coord.coordId).length > 0) {
                    <div class="towers-section">
                      <h4 class="towers-heading">
                        <ng-icon hlmIcon name="lucideLayoutGrid" size="sm" />
                        Towers ({{ getTowersForCoord(coord.coordId).length }})
                      </h4>
                      <div class="tower-list-scroll">
                        @for (tower of getTowersForCoord(coord.coordId); track tower.towerId) {
                          <div class="tower-item">
                            <div class="tower-header">
                              <span class="tower-name">{{ tower.name || tower.towerId }}</span>
                              <div class="tower-badges">
                                <span hlmBadge [variant]="tower.metadata.isConnected ? 'default' : 'outline'" class="connection-badge sm">
                                  {{ tower.metadata.isConnected ? 'On' : 'Off' }}
                                </span>
                                @if (tower.metadata.syncStatus) {
                                  <span hlmBadge [variant]="getSyncBadgeVariant(tower.metadata.syncStatus)" class="sm">
                                    {{ formatSyncLabel(tower.metadata.syncStatus) }}
                                  </span>
                                }
                              </div>
                            </div>
                            <div class="tower-sensors">
                              @if (tower.reported.airTempC != null) {
                                <span class="mini-sensor">
                                  <ng-icon hlmIcon name="lucideThermometer" size="xs" />
                                  {{ formatTemp(tower.reported.airTempC) }}&deg;C
                                </span>
                              }
                              @if (tower.reported.humidityPct != null) {
                                <span class="mini-sensor">
                                  <ng-icon hlmIcon name="lucideDroplet" size="xs" />
                                  {{ formatPercent(tower.reported.humidityPct) }}
                                </span>
                              }
                              @if (tower.reported.lightLux != null) {
                                <span class="mini-sensor">
                                  <ng-icon hlmIcon name="lucideSun" size="xs" />
                                  {{ formatNumber(tower.reported.lightLux, 0) }} lx
                                </span>
                              }
                              @if (tower.reported.vbatMv != null) {
                                <span class="mini-sensor">
                                  <ng-icon hlmIcon name="lucideBattery" size="xs" />
                                  {{ formatNumber(tower.reported.vbatMv, 0) }} mV
                                </span>
                              }
                              @if (tower.mlPredictions?.healthScore != null) {
                                <span class="mini-sensor health-score">
                                  <ng-icon hlmIcon name="lucideLeaf" size="xs" />
                                  {{ formatHealthScore(tower.mlPredictions!.healthScore) }}
                                </span>
                              }
                            </div>
                            @if (tower.cropType) {
                              <div class="tower-crop">
                                <ng-icon hlmIcon name="lucideFlower2" size="xs" />
                                <span>{{ tower.cropType }}</span>
                                @if (tower.mlPredictions?.daysToHarvest != null) {
                                  <span class="harvest-eta">
                                    <ng-icon hlmIcon name="lucideClock" size="xs" />
                                    {{ tower.mlPredictions!.daysToHarvest }}d to harvest
                                  </span>
                                }
                              </div>
                            }
                          </div>
                        }
                      </div>
                    </div>
                  }
                </div>
              }
            </div>
          }
        </section>
      }
    </div>
  </hlm-tabs>
</div>
