@use 'sass:color';

// ============================================
// Tokens
// ============================================
$card-radius: var(--radius);
$fast: 150ms ease;
$normal: 200ms ease;

$amber:  oklch(0.72 0.17 50);
$teal:   oklch(0.65 0.2 160);
$blue:   oklch(0.6 0.15 250);
$green:  oklch(0.65 0.19 155);

// ============================================
// Page Shell
// ============================================
.farm-overview {
  padding: 0.75rem 1rem;
  background: var(--background);
  height: 100%;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  gap: 0.625rem;
}

.dashboard-grid {
  display: flex;
  flex-direction: column;
  gap: 0.625rem;
  flex: 1;
  min-height: 0;
  overflow: hidden;
}

// ============================================
// Top Row — Compact stat cards
// ============================================
.top-row {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 0.5rem;
  flex-shrink: 0;
}

.stat-card {
  display: flex;
  align-items: center;
  gap: 0.625rem;
  padding: 0.625rem 0.875rem;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: $card-radius;
  transition: all $normal;

  &:hover { border-color: var(--ring); }
  &.has-alerts { border-color: var(--destructive); }
}

.stat-skeleton {
  width: 100%;
  height: 2rem;
  border-radius: 0.375rem;
  background: linear-gradient(90deg, var(--muted) 0%, var(--secondary) 50%, var(--muted) 100%);
  background-size: 200% 100%;
  animation: shimmer 1.5s ease-in-out infinite;
}

.stat-icon-sm {
  width: 2rem;
  height: 2rem;
  border-radius: 0.375rem;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--muted);
  color: var(--foreground);
  flex-shrink: 0;

  ng-icon {
    display: inline-flex !important;
    width: 1rem !important;
    height: 1rem !important;
  }

  &.critical {
    background: oklch(0.704 0.191 22.216 / 0.15);
    color: var(--destructive);
  }
}

.stat-body { display: flex; flex-direction: column; flex: 1; min-width: 0; }
.stat-value-sm { font-size: 1.125rem; font-weight: 700; color: var(--foreground); line-height: 1.2; letter-spacing: -0.025em; }
.stat-label-sm { font-size: 0.6875rem; color: var(--muted-foreground); font-weight: 500; }
.stat-badge { font-size: 0.625rem; padding: 0.125rem 0.375rem; flex-shrink: 0; }

// ============================================
// Bottom Row — Two-panel layout
// ============================================
.bottom-row {
  display: grid;
  grid-template-columns: 340px 1fr;
  gap: 0.5rem;
  flex: 1;
  min-height: 0;
  overflow: hidden;
}

.dashboard-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: $card-radius;
  overflow: hidden;
}

// ---- Graph Card (left) ----
.graph-card {
  display: flex;
  flex-direction: column;
  min-height: 0;
}

.graph-card-inner {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
  position: relative;
  padding: 1rem 1.25rem;
  overflow: hidden;
  min-height: 0;
}

.graph-empty {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  flex: 1;
  color: var(--muted-foreground);
  font-size: 0.8125rem;
}

.full-skeleton {
  width: 100%;
  height: 100%;
  min-height: 80px;
  border-radius: 0.5rem;
  background: linear-gradient(90deg, var(--muted) 0%, var(--secondary) 50%, var(--muted) 100%);
  background-size: 200% 100%;
  animation: shimmer 1.5s ease-in-out infinite;
}

// ============================================
// Farm Group — Linked-list topology
// ============================================
.farm-group {
  display: flex;
  flex-direction: column;
  gap: 1.25rem;
  border: 1.5px dashed oklch(0.4 0.01 260);
  border-radius: 0.75rem;
  padding: 1rem 1.25rem 1.25rem;
  position: relative;
  flex: 1;
  justify-content: center;
}

.farm-group-label {
  position: absolute;
  top: -0.5rem;
  left: 1rem;
  padding: 0 0.375rem;
  background: var(--card);
  font-size: 0.625rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--muted-foreground);
}

// ---- Coordinator Chain Row ----
.coord-chain {
  display: flex;
  align-items: center;
  gap: 0;
  flex-wrap: nowrap;
}

// ---- Chain Connector (line between nodes) ----
.chain-connector {
  display: flex;
  align-items: center;
  flex-shrink: 0;
  width: 32px;

  &.sibling { width: 20px; }
}

.connector-line {
  width: 100%;
  height: 2px;
  display: block;

  line {
    stroke: oklch(0.4 0.01 260);
    stroke-width: 1.5;
    vector-effect: non-scaling-stroke;
  }

  &.sibling line {
    stroke: oklch(0.35 0.01 260);
    stroke-dasharray: 3 2;
  }
}

// ---- Chain Node (clickable button) ----
.chain-node {
  display: flex;
  align-items: center;
  gap: 0.375rem;
  padding: 0.375rem 0.625rem;
  border: 1px solid var(--border);
  border-radius: 0.5rem;
  background: var(--card);
  cursor: pointer;
  transition: all $fast;
  flex-shrink: 0;
  white-space: nowrap;
  outline: none;
  font-family: inherit;
  font-size: 0.6875rem;
  color: var(--foreground);

  &:hover {
    border-color: var(--ring);
    background: var(--accent);
  }

  &.selected {
    border-color: $amber;
    box-shadow: 0 0 0 1px oklch(0.72 0.17 50 / 0.3), 0 0 12px oklch(0.72 0.17 50 / 0.15);
    background: oklch(0.72 0.17 50 / 0.06);
  }

  &.coord.selected {
    border-color: $amber;
    box-shadow: 0 0 0 1px oklch(0.72 0.17 50 / 0.3), 0 0 12px oklch(0.72 0.17 50 / 0.15);
  }

  &.tower.selected {
    border-color: $teal;
    box-shadow: 0 0 0 1px oklch(0.65 0.2 160 / 0.3), 0 0 12px oklch(0.65 0.2 160 / 0.15);
    background: oklch(0.65 0.2 160 / 0.06);
  }

  &:not(.connected) {
    opacity: 0.5;
  }
}

.chain-name {
  font-weight: 600;
  line-height: 1;
}

// ---- Chain Dots ----
.chain-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;

  &.coord-dot {
    background: $amber;
    box-shadow: 0 0 6px oklch(0.72 0.17 50 / 0.4);
  }

  &.tower-dot {
    background: transparent;
    border: 1.5px solid $teal;
    box-shadow: 0 0 6px oklch(0.65 0.2 160 / 0.3);
  }

  &.lg {
    width: 12px;
    height: 12px;
  }

  &.coord-dot.lg {
    box-shadow: 0 0 8px oklch(0.72 0.17 50 / 0.5);
  }

  &.tower-dot.lg {
    border-width: 2px;
    box-shadow: 0 0 8px oklch(0.65 0.2 160 / 0.4);
  }
}

// ---- Infra pills (bottom-left) ----
.infra-overlay {
  position: absolute;
  bottom: 0.5rem;
  right: 0.5rem;
  display: flex;
  gap: 0.25rem;
  z-index: 3;
}

.infra-pill {
  display: flex;
  align-items: center;
  gap: 0.2rem;
  padding: 0.15rem 0.35rem;
  border-radius: 0.25rem;
  border: 1px solid oklch(0.6 0.15 250 / 0.15);
  background: oklch(0.14 0.005 260 / 0.85);
  backdrop-filter: blur(4px);
  font-size: 0.5rem;
  font-weight: 600;
  color: var(--muted-foreground);
  line-height: 1;

  ng-icon {
    color: oklch(0.6 0.15 250 / 0.4);
    font-size: 0.5rem;
  }

  &.online {
    border-color: oklch(0.6 0.15 250 / 0.3);
    color: var(--foreground);
    ng-icon { color: $blue; }
  }
}

// ============================================
// Detail Card (right)
// ============================================
.detail-card {
  display: flex;
  flex-direction: column;
  min-height: 0;
  overflow: hidden;
}

.detail-card-inner {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow-y: auto;
  overflow-x: hidden;
  min-height: 0;

  &::-webkit-scrollbar { width: 3px; }
  &::-webkit-scrollbar-track { background: transparent; }
  &::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
  scrollbar-width: thin;
  scrollbar-color: var(--border) transparent;
}

.detail-empty {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  padding: 2rem;
  text-align: center;
  color: var(--muted-foreground);

  ng-icon { opacity: 0.3; }
}

.detail-empty-title {
  font-size: 0.875rem;
  font-weight: 600;
  color: var(--foreground);
}

.detail-empty-hint {
  font-size: 0.6875rem;
  max-width: 200px;
  line-height: 1.4;
}

// ---- Detail Content ----
.detail-content {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  padding: 0.75rem;
}

.detail-header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 0.5rem;
}

.detail-title-row {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.detail-title {
  font-size: 0.9375rem;
  font-weight: 700;
  color: var(--foreground);
  margin: 0;
  line-height: 1.2;
}

.detail-subtitle {
  font-size: 0.625rem;
  color: var(--muted-foreground);
  font-family: monospace;
}

.detail-close {
  background: none;
  border: 1px solid var(--border);
  border-radius: 0.25rem;
  padding: 0.2rem;
  cursor: pointer;
  color: var(--muted-foreground);
  transition: all $fast;
  display: flex;

  &:hover {
    color: var(--foreground);
    border-color: var(--ring);
    background: var(--accent);
  }
}

// ---- Status Row ----
.detail-status-row {
  display: flex;
  align-items: center;
  gap: 0.375rem;
  flex-wrap: wrap;
}

.detail-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.2rem;
  padding: 0.125rem 0.375rem;
  border-radius: 0.25rem;
  font-size: 0.5625rem;
  font-weight: 600;
  line-height: 1;
  border: 1px solid transparent;
}

.sync-badge {
  &.sync-ok     { background: oklch(0.65 0.19 155 / 0.12); color: $green; border-color: oklch(0.65 0.19 155 / 0.25); }
  &.sync-pending { background: oklch(0.72 0.17 50 / 0.12); color: $amber; border-color: oklch(0.72 0.17 50 / 0.25); }
  &.sync-warn   { background: oklch(0.704 0.191 22.216 / 0.12); color: var(--destructive); border-color: oklch(0.704 0.191 22.216 / 0.25); }
  &.sync-off    { background: var(--muted); color: var(--muted-foreground); }
}

.connected-badge {
  background: oklch(0.65 0.19 155 / 0.12);
  color: $green;
  border-color: oklch(0.65 0.19 155 / 0.25);
}

.offline-badge {
  background: var(--muted);
  color: var(--muted-foreground);
}

.crop-badge {
  background: oklch(0.65 0.2 160 / 0.1);
  color: $teal;
  border-color: oklch(0.65 0.2 160 / 0.2);

  ng-icon { font-size: 0.5rem; }
}

.detail-meta {
  font-size: 0.5625rem;
  color: var(--muted-foreground);
  margin-left: auto;
  font-family: monospace;
}

// ---- Detail Sections ----
.detail-section {
  display: flex;
  flex-direction: column;
  gap: 0.375rem;
}

.detail-section-title {
  font-size: 0.5625rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--muted-foreground);
  margin: 0;
  padding-bottom: 0.125rem;
  border-bottom: 1px solid oklch(0.3 0.01 260 / 0.3);
}

// ---- Detail Grid (sensor readings, 2 or 3 cols) ----
.detail-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 0.375rem;

  &.cols-3 { grid-template-columns: repeat(3, 1fr); }
}

.detail-cell {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.125rem;
  padding: 0.375rem 0.25rem;
  border-radius: 0.375rem;
  background: var(--muted);
  transition: background $fast;

  ng-icon {
    font-size: 0.625rem;
    color: var(--muted-foreground);
  }
}

.cell-label {
  font-size: 0.5rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  color: var(--muted-foreground);
}

.cell-value {
  font-size: 0.75rem;
  font-weight: 700;
  color: var(--foreground);
  line-height: 1;
}

// ---- Pump Cell ----
.pump-cell {
  flex-direction: row;
  justify-content: center;
  gap: 0.375rem;

  &.active .pump-dot {
    background: $green;
    box-shadow: 0 0 6px oklch(0.65 0.19 155 / 0.5);
  }
}

.pump-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: oklch(0.4 0 0);
  transition: all $normal;
  flex-shrink: 0;
}

// ---- Key-Value Rows ----
.detail-kv {
  display: flex;
  flex-direction: column;
  gap: 0;
}

.kv-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.25rem 0;
  font-size: 0.6875rem;
  border-bottom: 1px solid oklch(0.3 0.01 260 / 0.15);

  &:last-child { border-bottom: none; }

  span:first-child {
    color: var(--muted-foreground);
  }

  span:last-child {
    font-weight: 600;
    color: var(--foreground);
    font-family: monospace;
    font-size: 0.625rem;
  }
}

.kv-highlight {
  color: $green !important;
}

// ============================================
// System Health Sparklines
// ============================================
.system-health-section {
  flex-shrink: 0;
}

.system-health-header {
  display: flex;
  align-items: center;
  gap: 0.375rem;
  margin-bottom: 0.5rem;
  font-size: 0.75rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--muted-foreground);

  ng-icon {
    color: var(--primary);
  }
}

.system-health-title {
  line-height: 1;
}

.system-health-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 0.5rem;

  @media (max-width: 1024px) {
    grid-template-columns: repeat(2, 1fr);
  }

  @media (max-width: 768px) {
    grid-template-columns: 1fr;
  }
}

// ============================================
// Alerts Section
// ============================================
.alerts-section-standalone {
  flex-shrink: 0;
  background: oklch(0.145 0.005 285.823);
  border-radius: $card-radius;
  overflow: hidden;
  max-height: 280px;
  display: flex;
  flex-direction: column;
}

.alerts-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.75rem 1rem;
  border-bottom: 1px solid oklch(0.3 0.01 285.823);
  flex-shrink: 0;
}

.alerts-title {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin: 0;
  font-size: 0.8125rem;
  font-weight: 600;
  color: oklch(0.9 0 0);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.view-all-alerts {
  display: flex;
  align-items: center;
  gap: 0.25rem;
  font-size: 0.75rem;
  color: oklch(0.7 0 0);
  text-decoration: none;
  transition: color $fast;
  &:hover { color: oklch(0.9 0 0); }
}

.alerts-scroll-container {
  position: relative;
  flex: 1;
  min-height: 0;
  overflow: hidden;

  &::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 24px;
    background: linear-gradient(to top, oklch(0.145 0.005 285.823) 0%, oklch(0.145 0.005 285.823 / 0) 100%);
    pointer-events: none;
    z-index: 2;
  }
}

.alerts-scroll-content {
  display: flex;
  flex-direction: column;
  gap: 0.375rem;
  padding: 0.5rem 1rem 1rem;
  overflow-y: auto;
  max-height: 180px;

  &::-webkit-scrollbar { width: 4px; }
  &::-webkit-scrollbar-track { background: transparent; }
  &::-webkit-scrollbar-thumb { background: oklch(0.4 0 0); border-radius: 2px; }
}

.alerts-section-standalone .alert-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 0.75rem;
  background: oklch(0.2 0.005 285.823);
  border: 1px solid oklch(0.3 0.01 285.823);
  border-radius: 0.375rem;
  border-left: 3px solid transparent;
  transition: background $fast;
  font-size: 0.8125rem;

  &:hover { background: oklch(0.25 0.005 285.823); }
  &.alert-critical { border-left-color: var(--destructive); background: oklch(0.704 0.191 22.216 / 0.1); }
  &.alert-warning  { border-left-color: oklch(0.769 0.188 70.08); background: oklch(0.769 0.188 70.08 / 0.08); }
  &.alert-info     { border-left-color: $blue; background: oklch(0.6 0.15 250 / 0.08); }

  .alert-info { flex: 1; min-width: 0; }
  .alert-message { display: block; font-weight: 500; color: oklch(0.95 0 0); }
  .alert-meta { display: block; font-size: 0.6875rem; color: oklch(0.6 0 0); margin-top: 0.125rem; }
  ng-icon { color: oklch(0.7 0 0); flex-shrink: 0; }
  &.alert-critical ng-icon { color: var(--destructive); }
  &.alert-warning ng-icon  { color: oklch(0.769 0.188 70.08); }
  &.alert-info ng-icon     { color: $blue; }
}

// ============================================
// Responsive
// ============================================
@media (max-width: 1200px) {
  .bottom-row { grid-template-columns: 280px 1fr; }
}

@media (max-width: 1024px) {
  .top-row { grid-template-columns: repeat(2, 1fr); }
  .bottom-row { grid-template-columns: 1fr; }
}

@media (max-width: 768px) {
  .farm-overview { padding: 0.5rem; }
  .top-row { grid-template-columns: 1fr; }
}

// ============================================
// Status badge overrides
// ============================================
:host ::ng-deep {
  .status-online, .status-operational {
    background-color: var(--status-online) !important;
    color: var(--status-online-foreground) !important;
    border-color: transparent !important;
  }
  .status-offline {
    background-color: var(--status-offline) !important;
    color: var(--status-offline-foreground) !important;
    border-color: transparent !important;
  }
  .status-error {
    background-color: var(--status-error) !important;
    color: var(--status-error-foreground) !important;
    border-color: transparent !important;
  }
  .status-warning {
    background-color: var(--status-warning) !important;
    color: var(--status-warning-foreground) !important;
    border-color: transparent !important;
  }
  .status-pairing {
    background-color: var(--status-pairing) !important;
    color: var(--status-pairing-foreground) !important;
    border-color: transparent !important;
  }
  .status-ota {
    background-color: var(--status-warning) !important;
    color: var(--status-warning-foreground) !important;
    border-color: transparent !important;
  }
}

@keyframes shimmer {
  0%   { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}
