<div class="farm-overview">
  <!-- Dashboard Cards - Top Row (3 cards) -->
  <section class="dashboard-grid">
    <div class="top-row">
      <!-- Card 1: Reservoirs -->
      <div class="dashboard-card">
        <div class="card-inner">
          @if (loading()) {
            <hlm-skeleton class="full-skeleton" />
          } @else {
            <div class="card-content">
              <div class="card-header-section">
                <div class="stat-icon coordinators">
                  <ng-icon hlmIcon name="lucideServer" size="lg" />
                </div>
                <span hlmBadge variant="outline" class="status-badge">
                  @if (usingMockData()) {
                    Mock
                  } @else {
                    Live
                  }
                </span>
              </div>
              <div class="stat-info">
                <span class="stat-label">Reservoirs</span>
                <span class="stat-value">
                  {{ systemStats().coordinators.online }} / {{ systemStats().coordinators.total }}
                </span>
                <span class="stat-description">Active controllers</span>
              </div>
            </div>
          }
        </div>
      </div>

      <!-- Card 2: Towers -->
      <div class="dashboard-card">
        <div class="card-inner">
          @if (loading()) {
            <hlm-skeleton class="full-skeleton" />
          } @else {
            <div class="card-content">
              <div class="card-header-section">
                <div class="stat-icon towers">
                  <ng-icon hlmIcon name="lucideLayoutGrid" size="lg" />
                </div>
                <span hlmBadge variant="outline" class="status-badge">Active</span>
              </div>
              <div class="stat-info">
                <span class="stat-label">Towers</span>
                <span class="stat-value">
                  {{ systemStats().nodes.online }} / {{ systemStats().nodes.total }}
                </span>
                <span class="stat-description">
                  @if (systemStats().nodes.pairing > 0) {
                    {{ systemStats().nodes.pairing }} pairing
                  } @else if (systemStats().nodes.lowBattery > 0) {
                    {{ systemStats().nodes.lowBattery }} low battery
                  } @else {
                    Connected towers
                  }
                </span>
              </div>
            </div>
          }
        </div>
      </div>

      <!-- Card 3: Alerts -->
      <div class="dashboard-card" [class.has-alerts]="systemStats().alerts.critical > 0">
        <div class="card-inner">
          @if (loading()) {
            <hlm-skeleton class="full-skeleton" />
          } @else {
            <div class="card-content">
              <div class="card-header-section">
                <div class="stat-icon alerts" [class.critical]="systemStats().alerts.critical > 0">
                  <ng-icon hlmIcon name="lucideAlertTriangle" size="lg" />
                </div>
                @if (systemStats().alerts.critical > 0) {
                  <span hlmBadge variant="destructive" class="status-badge">Critical</span>
                } @else {
                  <span hlmBadge variant="outline" class="status-badge">OK</span>
                }
              </div>
              <div class="stat-info">
                <span class="stat-label">Alerts</span>
                <span class="stat-value">{{ systemStats().alerts.total }}</span>
                <span class="stat-description">
                  @if (systemStats().alerts.critical > 0) {
                    {{ systemStats().alerts.critical }} critical
                  } @else {
                    All systems normal
                  }
                </span>
              </div>
            </div>
          }
        </div>
      </div>
    </div>

    <!-- Main Content Card -->
    <div class="bottom-row">
      <div class="dashboard-card large-card">
        <div class="card-inner">
          @if (loading()) {
            <hlm-skeleton class="full-skeleton" />
          } @else {
            <div class="large-card-content">
              @if (error()) {
                <div class="error-banner">
                  <ng-icon hlmIcon name="lucideAlertTriangle" size="sm" />
                  <span>{{ error() }}</span>
                  <button hlmBtn variant="ghost" size="sm" (click)="refreshData()">Retry</button>
                </div>
              }

              @if (coordinators().length === 0 && nodes().length === 0) {
                <div class="empty-state">
                  <ng-icon hlmIcon name="lucideServer" size="xl" />
                  <h3>Welcome to Your Hydroponic Farm</h3>
                  <p>Get started by adding your first coordinator and towers to monitor your system in real-time.</p>
                  <div class="empty-state-actions">
                    <button hlmBtn variant="default" routerLink="/reservoirs">
                      <ng-icon hlmIcon name="lucidePlus" size="sm" />
                      Add Coordinator
                    </button>
                    <button hlmBtn variant="outline" routerLink="/settings">
                      <ng-icon hlmIcon name="lucideInfo" size="sm" />
                      Setup Guide
                    </button>
                  </div>
                </div>
              } @else {
                <!-- Devices Overview - Horizontal Layout -->
                <div class="devices-overview-inline">
                  <!-- Farms Column -->
                  @if (zones().length > 0) {
                    <div class="device-column">
                      <h4 class="device-section-title">Farms</h4>
                      <div class="device-list">
                        @for (zone of zones().slice(0, 4); track zone._id) {
                          <a [routerLink]="['/farms', zone._id]" class="device-item">
                            <div class="device-info">
                              <span class="device-name">{{ zone.name }}</span>
                              <span class="device-meta">
                                <ng-icon hlmIcon name="lucideMapPin" size="sm" />
                                {{ zone.site_id ? 'Site configured' : 'No site' }}
                              </span>
                            </div>
                            <ng-icon hlmIcon name="lucideChevronRight" size="sm" />
                          </a>
                        }
                        @if (zones().length > 4) {
                          <a routerLink="/farms" class="view-all-link">
                            View all {{ zones().length }} farms
                            <ng-icon hlmIcon name="lucideChevronRight" size="sm" />
                          </a>
                        }
                      </div>
                    </div>
                  }

                  <!-- Reservoirs Column -->
                  @if (coordinators().length > 0) {
                    <div class="device-column">
                      <h4 class="device-section-title">Reservoirs</h4>
                      <div class="device-list">
                        @for (coord of coordinators(); track trackByCoordinatorId($index, coord)) {
                          <a [routerLink]="['/reservoirs', coord.coord_id]" class="device-item">
                            <div class="device-info">
                              <span class="device-name">{{ coord.name || coord.coord_id }}</span>
                              <span class="device-meta">
                                {{ coord.nodes_online || 0 }} nodes |
                                {{ coord.light_lux || 0 }} lux |
                                {{ coord.temp_c !== undefined ? coord.temp_c.toFixed(1) : '--' }}°C
                              </span>
                            </div>
                            <span hlmBadge [variant]="getStatusBadgeVariant(coord.status)" size="sm" [class]="'status-' + coord.status">
                              {{ coord.status }}
                            </span>
                          </a>
                        }
                      </div>
                    </div>
                  }

                  <!-- Towers Column -->
                  @if (nodes().length > 0) {
                    <div class="device-column">
                      <h4 class="device-section-title">Towers</h4>
                      <div class="device-list">
                        @for (node of nodes().slice(0, 6); track trackByNodeId($index, node)) {
                          <a [routerLink]="['/towers', node._id]" class="device-item">
                            <div class="device-info">
                              <span class="device-name">{{ node.name || node.light_id }}</span>
                              <span class="device-meta">
                                {{ node.temp_c !== undefined ? node.temp_c.toFixed(1) : '--' }}°C |
                                {{ node.vbat_mv || '--' }} mV |
                                {{ formatLastSeen(node.last_seen) }}
                              </span>
                            </div>
                            <span hlmBadge [variant]="getStatusBadgeVariant(node.status_mode)" size="sm" [class]="'status-' + node.status_mode">
                              {{ getNodeStatusDisplay(node.status_mode) }}
                            </span>
                          </a>
                        }
                        @if (nodes().length > 6) {
                          <a routerLink="/towers" class="view-all-link">
                            View all {{ nodes().length }} towers
                            <ng-icon hlmIcon name="lucideChevronRight" size="sm" />
                          </a>
                        }
                      </div>
                    </div>
                  }
                </div>
              }
            </div>
          }
        </div>
      </div>
    </div>
  </section>

  <!-- Alerts Section - Outside Card -->
  @if (activeAlerts().length > 0) {
    <section class="alerts-section-standalone">
      <div class="alerts-header">
        <h4 class="alerts-title">
          <ng-icon hlmIcon name="lucideAlertTriangle" size="sm" />
          Recent Alerts
        </h4>
        @if (activeAlerts().length > 5) {
          <a routerLink="/alerts" class="view-all-alerts">
            View all {{ activeAlerts().length }}
            <ng-icon hlmIcon name="lucideChevronRight" size="sm" />
          </a>
        }
      </div>
      <div class="alerts-scroll-container">
        <div class="alerts-scroll-content">
          @for (alert of activeAlerts(); track trackByAlertId($index, alert)) {
            <div class="alert-item" [class]="'alert-' + alert.severity">
              <ng-icon hlmIcon name="lucideAlertTriangle" size="sm" />
              <div class="alert-info">
                <span class="alert-message">{{ alert.message }}</span>
                <span class="alert-meta">{{ alert.source.name }} - {{ formatTimestamp(alert.createdAt) }}</span>
              </div>
              <span hlmBadge [variant]="getAlertBadgeVariant(alert.severity)" size="sm">
                {{ alert.severity }}
              </span>
            </div>
          }
        </div>
      </div>
    </section>
  }
</div>
