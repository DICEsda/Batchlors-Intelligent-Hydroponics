<div class="tower-detail">
  <!-- Header with back navigation -->
  <header class="page-header">
    <div class="header-left">
      <a routerLink="/overview" hlmBtn variant="ghost" size="icon" class="back-btn">
        <ng-icon hlmIcon name="lucideArrowLeft" size="sm" />
      </a>
      <div class="header-content">
        @if (loading()) {
          <hlm-skeleton class="title-skeleton" />
        } @else {
          <h1 class="page-title">{{ tower()?.name || 'Tower' }}</h1>
          <p class="page-description">
            @if (tower()) {
              <span hlmBadge [variant]="getStatusBadgeVariant(tower()!.status)">
                <ng-icon hlmIcon [name]="tower()!.status === 'online' ? 'lucideWifi' : 'lucideWifiOff'" size="xs" />
                {{ tower()!.status }}
              </span>
              <span class="separator">•</span>
              <span>{{ slotStats().occupied }}/{{ slotStats().total }} slots occupied</span>
              <span class="separator">•</span>
              <span>Firmware v{{ tower()!.firmwareVersion }}</span>
            }
          </p>
        }
      </div>
    </div>
    <div class="header-actions">
      <span
        hlmBadge
        [variant]="wsConnected() ? 'outline' : 'destructive'"
        class="live-badge"
      >
        <span class="live-dot" [class.active]="wsConnected()"></span>
        {{ wsConnected() ? 'Live' : 'Offline' }}
      </span>
      <button hlmBtn variant="outline" size="sm" (click)="refreshData()">
        <ng-icon hlmIcon name="lucideRefreshCw" size="sm" />
        Refresh
      </button>
      <button hlmBtn variant="outline" size="sm">
        <ng-icon hlmIcon name="lucideSettings" size="sm" />
        Settings
      </button>
    </div>
  </header>

  <!-- Error State -->
  @if (error()) {
    <div class="error-banner">
      <ng-icon hlmIcon name="lucideAlertTriangle" size="sm" />
      <span>{{ error() }}</span>
      <button hlmBtn variant="ghost" size="sm" (click)="refreshData()">Retry</button>
    </div>
  }

  <!-- Loading State -->
  @if (loading()) {
    <div class="loading-grid">
      @for (i of [1, 2, 3]; track i) {
        <div hlmCard class="metric-card">
          <hlm-skeleton class="metric-skeleton" />
        </div>
      }
    </div>
  } @else if (tower()) {
    <!-- Sensor Data Section -->
    <section class="sensors-section">
      <h2 class="section-title">Environmental Sensors</h2>
      @if (sensorData(); as sensors) {
        <div class="sensors-grid">
          <!-- Temperature -->
          <div hlmCard class="sensor-card" [class]="'status-' + tempStatus().color">
            <div hlmCardHeader class="sensor-header">
              <ng-icon hlmIcon name="lucideThermometer" size="lg" class="sensor-icon temp" />
              <div class="sensor-info">
                <span hlmCardDescription>Temperature</span>
                <span hlmCardTitle class="sensor-value">{{ sensors.ambientTemp | number:'1.1-1' }}°C</span>
              </div>
            </div>
            <div hlmCardContent class="sensor-content">
              <div class="gauge-container">
                <div class="gauge-bar">
                  <div
                    class="gauge-fill"
                    [style.width.%]="((sensors.ambientTemp - 10) / 30) * 100"
                    [class]="'fill-' + tempStatus().color"
                  ></div>
                  <div class="gauge-optimal" style="left: 33.3%; width: 20%"></div>
                </div>
                <div class="gauge-labels">
                  <span>10°C</span>
                  <span>Optimal: 20-26°C</span>
                  <span>40°C</span>
                </div>
              </div>
              <span class="sensor-status" [class]="'status-' + tempStatus().color">
                {{ tempStatus().status }}
              </span>
            </div>
          </div>

          <!-- Humidity -->
          <div hlmCard class="sensor-card" [class]="'status-' + humidityStatus().color">
            <div hlmCardHeader class="sensor-header">
              <ng-icon hlmIcon name="lucideDroplet" size="lg" class="sensor-icon humidity" />
              <div class="sensor-info">
                <span hlmCardDescription>Humidity</span>
                <span hlmCardTitle class="sensor-value">{{ sensors.humidity | number:'1.0-0' }}%</span>
              </div>
            </div>
            <div hlmCardContent class="sensor-content">
              <div class="gauge-container">
                <div class="gauge-bar">
                  <div
                    class="gauge-fill"
                    [style.width.%]="sensors.humidity"
                    [class]="'fill-' + humidityStatus().color"
                  ></div>
                  <div class="gauge-optimal" style="left: 50%; width: 20%"></div>
                </div>
                <div class="gauge-labels">
                  <span>0%</span>
                  <span>Optimal: 50-70%</span>
                  <span>100%</span>
                </div>
              </div>
              <span class="sensor-status" [class]="'status-' + humidityStatus().color">
                {{ humidityStatus().status }}
              </span>
            </div>
          </div>

          <!-- Light Level -->
          <div hlmCard class="sensor-card" [class]="'status-' + lightStatus().color">
            <div hlmCardHeader class="sensor-header">
              <ng-icon hlmIcon name="lucideSun" size="lg" class="sensor-icon light" />
              <div class="sensor-info">
                <span hlmCardDescription>Light Level</span>
                <span hlmCardTitle class="sensor-value">{{ sensors.lightLevel | number:'1.0-0' }} lux</span>
              </div>
            </div>
            <div hlmCardContent class="sensor-content">
              <div class="gauge-container">
                <div class="gauge-bar">
                  <div
                    class="gauge-fill"
                    [style.width.%]="(sensors.lightLevel / 40000) * 100"
                    [class]="'fill-' + lightStatus().color"
                  ></div>
                  <div class="gauge-optimal" style="left: 25%; width: 37.5%"></div>
                </div>
                <div class="gauge-labels">
                  <span>0</span>
                  <span>Optimal: 10k-25k</span>
                  <span>40k</span>
                </div>
              </div>
              <span class="sensor-status" [class]="'status-' + lightStatus().color">
                {{ lightStatus().status }}
              </span>
            </div>
          </div>
        </div>

        <!-- Last update timestamp -->
        <div class="last-update">
          <ng-icon hlmIcon name="lucideClock" size="xs" />
          <span>Last updated: {{ formatTimeAgo(sensors.lastUpdated) }}</span>
          @if (liveTelemetry()) {
            <span hlmBadge variant="outline" class="live-indicator">
              <ng-icon hlmIcon name="lucideZap" size="xs" />
              Real-time
            </span>
          }
        </div>
      } @else {
        <div class="no-data">
          <ng-icon hlmIcon name="lucideAlertTriangle" size="lg" />
          <p>No sensor data available</p>
        </div>
      }
    </section>

    <!-- LED Control Section -->
    <section class="led-section">
      <div class="section-header">
        <h2 class="section-title">LED Lighting</h2>
        <span hlmBadge [variant]="ledActive() ? 'default' : 'secondary'">
          <ng-icon hlmIcon name="lucidePower" size="xs" />
          {{ ledActive() ? 'Active' : 'Off' }}
        </span>
      </div>

      <div class="led-grid">
        <!-- LED Status Card -->
        <div hlmCard class="led-status-card">
          <div hlmCardHeader>
            <span hlmCardTitle>LED Status</span>
            <span hlmCardDescription>Current lighting configuration</span>
          </div>
          <div hlmCardContent>
            <div class="led-info-grid">
              <div class="led-info-item">
                <ng-icon hlmIcon name="lucidePower" size="sm" />
                <span class="label">Status</span>
                <span class="value" [class.active]="ledActive()">{{ ledActive() ? 'ON' : 'OFF' }}</span>
              </div>
              <div class="led-info-item">
                <ng-icon hlmIcon name="lucideSun" size="sm" />
                <span class="label">Brightness</span>
                <span class="value">{{ tower()?.ledBrightness || 0 }}%</span>
              </div>
            </div>
          </div>
        </div>

        <!-- LED Schedule Card -->
        @if (ledSchedule(); as schedule) {
          <div hlmCard class="led-schedule-card">
            <div hlmCardHeader>
              <span hlmCardTitle>Light Schedule</span>
              <span hlmCardDescription>
                {{ schedule.enabled ? 'Automated lighting cycle' : 'Schedule disabled' }}
              </span>
            </div>
            <div hlmCardContent>
              @if (schedule.enabled) {
                <div class="schedule-times">
                  <div class="time-block on">
                    <ng-icon hlmIcon name="lucideSunrise" size="sm" />
                    <span class="time-label">Lights On</span>
                    <span class="time-value">{{ schedule.onTime }}</span>
                  </div>
                  <div class="time-divider">
                    <span class="divider-line"></span>
                    <ng-icon hlmIcon name="lucideSun" size="xs" />
                    <span class="divider-line"></span>
                  </div>
                  <div class="time-block off">
                    <ng-icon hlmIcon name="lucideSunset" size="sm" />
                    <span class="time-label">Lights Off</span>
                    <span class="time-value">{{ schedule.offTime }}</span>
                  </div>
                </div>
                @if (schedule.spectrum) {
                  <div class="spectrum-info">
                    <span class="spectrum-label">Spectrum Mix</span>
                    <div class="spectrum-bars">
                      <div class="spectrum-bar red" [style.width.%]="schedule.spectrum.red">R</div>
                      <div class="spectrum-bar blue" [style.width.%]="schedule.spectrum.blue">B</div>
                      <div class="spectrum-bar white" [style.width.%]="schedule.spectrum.white">W</div>
                    </div>
                  </div>
                }
              } @else {
                <div class="schedule-disabled">
                  <p>Light schedule is currently disabled. LEDs are controlled manually.</p>
                </div>
              }
            </div>
          </div>
        }
      </div>
    </section>

    <!-- Plant Slots Section -->
    <section class="plants-section">
      <div class="section-header">
        <h2 class="section-title">Plant Slots</h2>
        <div class="slot-stats">
          <span hlmBadge variant="outline">
            <ng-icon hlmIcon name="lucideSprout" size="xs" />
            {{ slotStats().occupied }} plants
          </span>
          <span hlmBadge variant="secondary">
            <ng-icon hlmIcon name="lucideGrid3x3" size="xs" />
            {{ slotStats().empty }} empty
          </span>
          @if (slotStats().avgHealth > 0) {
            <span hlmBadge [variant]="slotStats().avgHealth >= 80 ? 'default' : 'secondary'">
              Avg Health: {{ slotStats().avgHealth | number:'1.0-0' }}%
            </span>
          }
        </div>
      </div>

      @if (plantSlots().length === 0) {
        <div class="empty-state">
          <ng-icon hlmIcon name="lucideFlower2" size="xl" />
          <h3>No Plant Slots</h3>
          <p>This tower has no configured plant slots.</p>
        </div>
      } @else {
        <div class="plants-grid">
          @for (slot of plantSlots(); track trackBySlotIndex($index, slot)) {
            <div hlmCard class="plant-card" [class.empty]="slot.isEmpty">
              <div hlmCardHeader class="plant-header">
                <div class="slot-number">{{ slot.slotIndex }}</div>
                <div class="plant-info">
                  @if (slot.isEmpty) {
                    <span hlmCardTitle class="empty-label">Empty Slot</span>
                    <span hlmCardDescription>No plant</span>
                  } @else {
                    <span hlmCardTitle>{{ slot.plantType || 'Unknown Plant' }}</span>
                    <span hlmCardDescription>
                      @if (slot.plantedDate) {
                        Planted {{ formatDaysAgo(slot.plantedDate) }} ago
                      }
                    </span>
                  }
                </div>
                @if (!slot.isEmpty && slot.metrics) {
                  <span 
                    hlmBadge 
                    [variant]="getHealthColor(slot.metrics.healthScore) === 'green' ? 'default' : 'secondary'"
                    class="health-badge"
                  >
                    {{ slot.metrics.healthScore }}%
                  </span>
                }
              </div>
              
              @if (!slot.isEmpty && slot.metrics) {
                <div hlmCardContent class="plant-metrics">
                  <div class="metric">
                    <ng-icon hlmIcon name="lucideTrendingUp" size="xs" />
                    <span class="metric-label">Height</span>
                    <span class="metric-value">{{ slot.metrics.heightCm | number:'1.1-1' }} cm</span>
                  </div>
                  @if (slot.metrics.growthRate) {
                    <div class="metric">
                      <ng-icon hlmIcon name="lucideActivity" size="xs" />
                      <span class="metric-label">Growth</span>
                      <span class="metric-value">{{ slot.metrics.growthRate | number:'1.2-2' }} cm/day</span>
                    </div>
                  }
                  @if (slot.metrics.leafCount) {
                    <div class="metric">
                      <ng-icon hlmIcon name="lucideSprout" size="xs" />
                      <span class="metric-label">Leaves</span>
                      <span class="metric-value">{{ slot.metrics.leafCount }}</span>
                    </div>
                  }
                </div>
              }
            </div>
          }
        </div>
      }
    </section>

    <!-- 3D Visualization Placeholder -->
    <section class="visualization-section">
      <div class="section-header">
        <h2 class="section-title">Tower Visualization</h2>
        <span hlmBadge variant="outline">Coming Soon</span>
      </div>
      <div class="visualization-placeholder">
        <ng-icon hlmIcon name="lucideFlower2" size="xl" />
        <h3>3D Tower View</h3>
        <p>Interactive 3D visualization of this tower will be available here.</p>
        <p class="hint">Shows real-time plant growth and LED status</p>
      </div>
    </section>

    <!-- System Info Footer -->
    <section class="system-info">
      <div class="info-row">
        <span class="info-label">
          <ng-icon hlmIcon name="lucidePlug" size="xs" />
          MAC Address
        </span>
        <span class="info-value">{{ tower()?.macAddress }}</span>
      </div>
      <div class="info-row">
        <span class="info-label">
          <ng-icon hlmIcon name="lucideActivity" size="xs" />
          Uptime
        </span>
        <span class="info-value">{{ (tower()?.uptime || 0) / 3600 | number:'1.1-1' }} hours</span>
      </div>
      <div class="info-row">
        <span class="info-label">
          <ng-icon hlmIcon name="lucideZap" size="xs" />
          Free Heap
        </span>
        <span class="info-value">{{ (tower()?.heapFree || 0) / 1024 | number:'1.0-0' }} KB</span>
      </div>
    </section>
  }
</div>
